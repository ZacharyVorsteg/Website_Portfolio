<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valuation Simulator - DCF + Multiples Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .metric-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(20, 184, 166, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        /* Critical: Fixed chart container dimensions */
        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 250px;
            max-height: 250px;
            overflow: hidden;
        }
        
        .chart-wrapper canvas {
            position: absolute !important;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }
        
        @media (min-width: 768px) {
            .chart-wrapper {
                height: 300px;
                max-height: 300px;
            }
        }
        
        .info-tooltip {
            position: relative;
            display: inline-block;
        }
        
        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: rgba(0, 0, 0, 0.95);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 50;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            font-size: 12px;
            line-height: 1.4;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Prevent any expansion */
        .no-grow {
            flex-grow: 0;
            flex-shrink: 0;
        }
        
        /* Table responsiveness */
        .table-container {
            max-width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .table-container table {
            min-width: 400px;
        }
        
        /* Prevent content jumping */
        input[type="range"] {
            width: 100%;
        }
        
        .slider-group {
            min-height: 65px;
        }
    </style>
</head>
<body class="text-gray-100 min-h-screen">
    <div class="w-full max-w-7xl mx-auto p-4 md:p-6 lg:p-8">
        <!-- Header -->
        <div class="glass-card rounded-xl p-4 md:p-6 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-emerald-400 to-teal-400 bg-clip-text text-transparent">
                    Valuation Simulator (DCF + Multiples)
                </h1>
                <span class="inline-block px-3 py-1.5 bg-emerald-500/20 text-emerald-400 rounded-lg text-xs md:text-sm font-medium">
                    Interactive Demo
                </span>
            </div>
            <p class="text-gray-400 mb-4 text-sm md:text-base">
                Calculate enterprise value using Discounted Cash Flow (DCF) and comparable company analysis. 
                Adjust assumptions to see real-time valuation changes.
            </p>
            <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 flex items-start gap-2">
                <i data-lucide="info" class="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5"></i>
                <div class="text-xs md:text-sm text-gray-300">
                    <strong>How to use:</strong> Adjust the sliders below to change company assumptions. 
                    The model automatically recalculates enterprise value, multiples, and sensitivity analysis. 
                    Hover over <i data-lucide="help-circle" class="w-3 h-3 inline"></i> icons for explanations.
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Panel - Assumptions -->
            <div class="lg:col-span-1">
                <div class="glass-card rounded-xl p-4 md:p-6">
                    <h2 class="text-lg md:text-xl font-bold mb-6 flex items-center gap-2">
                        <i data-lucide="settings" class="w-5 h-5 text-emerald-400"></i>
                        Company Assumptions
                        <div class="info-tooltip ml-auto">
                            <i data-lucide="help-circle" class="w-4 h-4 text-gray-400 cursor-help"></i>
                            <span class="tooltip-text">
                                Adjust these inputs to see how different assumptions impact the company's valuation.
                            </span>
                        </div>
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- Revenue Input -->
                        <div>
                            <label class="text-xs md:text-sm text-gray-400 mb-2 flex items-center gap-2">
                                Current Annual Revenue ($ Millions)
                                <div class="info-tooltip">
                                    <i data-lucide="help-circle" class="w-3 h-3 text-gray-500 cursor-help"></i>
                                    <span class="tooltip-text">
                                        The company's trailing twelve months (TTM) revenue. This is the base for all projections.
                                    </span>
                                </div>
                            </label>
                            <input type="number" id="currentRevenue" value="50" min="10" max="1000" step="5"
                                   class="w-full bg-white/10 rounded-lg px-3 py-2 text-white text-sm"
                                   onchange="calculateDCF()">
                        </div>

                        <!-- Growth Rate -->
                        <div class="slider-group">
                            <label class="text-xs md:text-sm text-gray-400 mb-2 flex items-center gap-2">
                                Revenue Growth Rate
                                <div class="info-tooltip">
                                    <i data-lucide="help-circle" class="w-3 h-3 text-gray-500 cursor-help"></i>
                                    <span class="tooltip-text">
                                        Expected annual growth rate. Higher growth = higher valuation.
                                    </span>
                                </div>
                            </label>
                            <input type="range" id="growthRate" min="0" max="50" value="25" step="5" 
                                   class="w-full h-2 rounded-lg appearance-none cursor-pointer bg-gradient-to-r from-emerald-500 to-teal-500">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0%</span>
                                <span id="growthRateValue" class="text-emerald-400 font-bold">25%</span>
                                <span>50%</span>
                            </div>
                        </div>

                        <!-- EBITDA Margin -->
                        <div class="slider-group">
                            <label class="text-xs md:text-sm text-gray-400 mb-2 flex items-center gap-2">
                                EBITDA Margin
                                <div class="info-tooltip">
                                    <i data-lucide="help-circle" class="w-3 h-3 text-gray-500 cursor-help"></i>
                                    <span class="tooltip-text">
                                        Operating profitability as % of revenue.
                                    </span>
                                </div>
                            </label>
                            <input type="range" id="ebitdaMargin" min="5" max="50" value="25" step="5" 
                                   class="w-full h-2 rounded-lg appearance-none cursor-pointer bg-gradient-to-r from-emerald-500 to-teal-500">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>5%</span>
                                <span id="ebitdaMarginValue" class="text-emerald-400 font-bold">25%</span>
                                <span>50%</span>
                            </div>
                        </div>

                        <!-- Terminal Growth -->
                        <div class="slider-group">
                            <label class="text-xs md:text-sm text-gray-400 mb-2 flex items-center gap-2">
                                Terminal Growth Rate
                                <div class="info-tooltip">
                                    <i data-lucide="help-circle" class="w-3 h-3 text-gray-500 cursor-help"></i>
                                    <span class="tooltip-text">
                                        Long-term growth rate (should be < WACC).
                                    </span>
                                </div>
                            </label>
                            <input type="range" id="terminalGrowth" min="0" max="10" value="3" step="1" 
                                   class="w-full h-2 rounded-lg appearance-none cursor-pointer bg-gradient-to-r from-emerald-500 to-teal-500">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0%</span>
                                <span id="terminalGrowthValue" class="text-emerald-400 font-bold">3%</span>
                                <span>10%</span>
                            </div>
                        </div>

                        <!-- WACC -->
                        <div class="slider-group">
                            <label class="text-xs md:text-sm text-gray-400 mb-2 flex items-center gap-2">
                                WACC (Discount Rate)
                                <div class="info-tooltip">
                                    <i data-lucide="help-circle" class="w-3 h-3 text-gray-500 cursor-help"></i>
                                    <span class="tooltip-text">
                                        Cost of capital. Higher WACC = lower valuation.
                                    </span>
                                </div>
                            </label>
                            <input type="range" id="wacc" min="5" max="20" value="10" step="1" 
                                   class="w-full h-2 rounded-lg appearance-none cursor-pointer bg-gradient-to-r from-emerald-500 to-teal-500">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>5%</span>
                                <span id="waccValue" class="text-emerald-400 font-bold">10%</span>
                                <span>20%</span>
                            </div>
                        </div>

                        <!-- Tax Rate -->
                        <div class="slider-group">
                            <label class="text-xs md:text-sm text-gray-400 mb-2 flex items-center gap-2">
                                Tax Rate
                                <div class="info-tooltip">
                                    <i data-lucide="help-circle" class="w-3 h-3 text-gray-500 cursor-help"></i>
                                    <span class="tooltip-text">
                                        Corporate tax rate (US federal = 21%).
                                    </span>
                                </div>
                            </label>
                            <input type="range" id="taxRate" min="15" max="35" value="21" step="1" 
                                   class="w-full h-2 rounded-lg appearance-none cursor-pointer bg-gradient-to-r from-emerald-500 to-teal-500">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>15%</span>
                                <span id="taxRateValue" class="text-emerald-400 font-bold">21%</span>
                                <span>35%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-6 space-y-3">
                        <button onclick="resetAssumptions()" 
                                class="w-full py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            Reset to Defaults
                        </button>
                        <button onclick="exportResults()" 
                                class="w-full py-2 bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 rounded-lg transition-colors flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Export Analysis
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Results -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Key Metrics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="metric-card rounded-xl p-3">
                        <div class="text-xs text-gray-400 mb-1">Enterprise Value</div>
                        <div id="enterpriseValue" class="text-lg md:text-xl font-bold text-emerald-400">$0M</div>
                        <div id="evMultiple" class="text-xs text-gray-500 mt-1">0.0x Revenue</div>
                    </div>
                    <div class="metric-card rounded-xl p-3">
                        <div class="text-xs text-gray-400 mb-1">EV/EBITDA</div>
                        <div id="evEbitda" class="text-lg md:text-xl font-bold text-teal-400">0.0x</div>
                        <div class="text-xs text-gray-500 mt-1">Multiple</div>
                    </div>
                    <div class="metric-card rounded-xl p-3">
                        <div class="text-xs text-gray-400 mb-1">Terminal Value</div>
                        <div id="terminalValue" class="text-lg md:text-xl font-bold text-blue-400">$0M</div>
                        <div id="terminalPercent" class="text-xs text-gray-500 mt-1">0% of EV</div>
                    </div>
                    <div class="metric-card rounded-xl p-3">
                        <div class="text-xs text-gray-400 mb-1">IRR (5-Year)</div>
                        <div id="irr" class="text-lg md:text-xl font-bold text-purple-400">0%</div>
                        <div class="text-xs text-gray-500 mt-1">Expected</div>
                    </div>
                </div>

                <!-- DCF Chart -->
                <div class="glass-card rounded-xl p-4 md:p-6">
                    <h3 class="text-base md:text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-5 h-5 text-emerald-400"></i>
                        DCF Cash Flow Projections
                    </h3>
                    <div class="chart-wrapper">
                        <canvas id="dcfChart"></canvas>
                    </div>
                </div>

                <!-- Comparable Companies -->
                <div class="glass-card rounded-xl p-4 md:p-6">
                    <h3 class="text-base md:text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="building" class="w-5 h-5 text-teal-400"></i>
                        Comparable Company Analysis
                    </h3>
                    <div class="table-container">
                        <table class="w-full text-xs md:text-sm">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left py-2 text-gray-400">Company</th>
                                    <th class="text-right py-2 text-gray-400">EV/Rev</th>
                                    <th class="text-right py-2 text-gray-400">EV/EBITDA</th>
                                    <th class="text-right py-2 text-gray-400">P/E</th>
                                    <th class="text-right py-2 text-gray-400">Growth</th>
                                </tr>
                            </thead>
                            <tbody id="compsTable">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-3 bg-white/5 rounded-lg">
                        <div class="flex justify-between text-xs">
                            <span class="text-gray-400">Median EV/Revenue:</span>
                            <span id="medianMultiple" class="text-emerald-400 font-bold">0.0x</span>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span class="text-gray-400">Comps Valuation:</span>
                            <span id="compsValuation" class="text-emerald-400 font-bold">$0M</span>
                        </div>
                    </div>
                </div>

                <!-- Sensitivity Table -->
                <div class="glass-card rounded-xl p-4 md:p-6">
                    <h3 class="text-base md:text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="sliders" class="w-5 h-5 text-blue-400"></i>
                        Sensitivity: WACC vs Terminal Growth
                    </h3>
                    <div id="sensitivityTable" class="table-container">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global chart variable
        let dcfChart = null;
        let chartInitialized = false;

        // Format number with commas
        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        // Initialize chart with proper constraints
        function initChart() {
            const canvas = document.getElementById('dcfChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (dcfChart) {
                dcfChart.destroy();
                dcfChart = null;
            }
            
            // Create new chart with strict configuration
            dcfChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5'],
                    datasets: [
                        {
                            label: 'Revenue',
                            data: [0, 0, 0, 0, 0],
                            type: 'line',
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1',
                            order: 1
                        },
                        {
                            label: 'Free Cash Flow',
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(20, 184, 166, 0.5)',
                            borderColor: '#14b8a6',
                            borderWidth: 1,
                            yAxisID: 'y',
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: 0
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { 
                                color: '#9CA3AF',
                                font: { size: 10 },
                                padding: 10,
                                boxWidth: 12,
                                boxHeight: 12
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#333',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': $';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatNumber(context.parsed.y) + 'M';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: { 
                                color: '#9CA3AF',
                                font: { size: 10 }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: { 
                                color: '#9CA3AF',
                                font: { size: 10 },
                                callback: function(value) {
                                    return '$' + Math.round(value) + 'M';
                                }
                            },
                            title: {
                                display: true,
                                text: 'FCF ($M)',
                                color: '#9CA3AF',
                                font: { size: 10 }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { 
                                drawOnChartArea: false,
                                drawBorder: false
                            },
                            ticks: { 
                                color: '#9CA3AF',
                                font: { size: 10 },
                                callback: function(value) {
                                    return '$' + Math.round(value) + 'M';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Revenue ($M)',
                                color: '#9CA3AF',
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
            
            chartInitialized = true;
        }

        // Calculate DCF
        function calculateDCF() {
            if (!chartInitialized) return;
            
            const revenue = parseFloat(document.getElementById('currentRevenue').value) || 50;
            const growthRate = parseFloat(document.getElementById('growthRate').value) / 100;
            const ebitdaMargin = parseFloat(document.getElementById('ebitdaMargin').value) / 100;
            const terminalGrowth = parseFloat(document.getElementById('terminalGrowth').value) / 100;
            const wacc = parseFloat(document.getElementById('wacc').value) / 100;
            const taxRate = parseFloat(document.getElementById('taxRate').value) / 100;

            // Validate
            if (terminalGrowth >= wacc) {
                document.getElementById('enterpriseValue').textContent = 'Invalid';
                document.getElementById('evMultiple').textContent = 'Terminal > WACC';
                return;
            }

            // Calculate projections
            const revenues = [];
            const cashFlows = [];
            const pvCashFlows = [];
            let currentRev = revenue;

            for (let i = 1; i <= 5; i++) {
                currentRev = currentRev * (1 + growthRate);
                revenues.push(currentRev);
                
                const ebitda = currentRev * ebitdaMargin;
                const tax = ebitda * taxRate;
                const fcf = ebitda - tax - (currentRev * 0.05);
                cashFlows.push(fcf);
                
                const pv = fcf / Math.pow(1 + wacc, i);
                pvCashFlows.push(pv);
            }

            // Terminal value
            const terminalFCF = cashFlows[4] * (1 + terminalGrowth);
            const terminalValue = terminalFCF / (wacc - terminalGrowth);
            const pvTerminalValue = terminalValue / Math.pow(1 + wacc, 5);
            const totalPVCashFlows = pvCashFlows.reduce((a, b) => a + b, 0);
            const enterpriseValue = totalPVCashFlows + pvTerminalValue;

            // Update chart data
            if (dcfChart && dcfChart.data) {
                dcfChart.data.datasets[0].data = revenues;
                dcfChart.data.datasets[1].data = cashFlows;
                dcfChart.update('none');
            }

            // Update metrics
            document.getElementById('enterpriseValue').textContent = `$${formatNumber(enterpriseValue)}M`;
            document.getElementById('evMultiple').textContent = `${(enterpriseValue / revenue).toFixed(1)}x Revenue`;
            document.getElementById('evEbitda').textContent = `${(enterpriseValue / (revenue * ebitdaMargin)).toFixed(1)}x`;
            document.getElementById('terminalValue').textContent = `$${formatNumber(terminalValue)}M`;
            document.getElementById('terminalPercent').textContent = `${(pvTerminalValue / enterpriseValue * 100).toFixed(0)}% of EV`;
            
            const irr = Math.pow(enterpriseValue / revenue, 1/5) - 1;
            document.getElementById('irr').textContent = `${(irr * 100).toFixed(1)}%`;

            generateComps(revenue, enterpriseValue);
            generateSensitivity(revenue, growthRate, ebitdaMargin, terminalGrowth, wacc, taxRate);
        }

        // Generate comparables
        function generateComps(revenue, ourEV) {
            const companies = [
                { name: 'TechCo A', evRevenue: 4.5, evEbitda: 18, pe: 25, growth: 30 },
                { name: 'SaaS B', evRevenue: 5.2, evEbitda: 20, pe: 28, growth: 35 },
                { name: 'Platform C', evRevenue: 3.8, evEbitda: 15, pe: 22, growth: 25 },
                { name: 'Enterprise D', evRevenue: 6.1, evEbitda: 22, pe: 30, growth: 40 },
                { name: 'Cloud E', evRevenue: 4.9, evEbitda: 19, pe: 26, growth: 32 }
            ];

            const tbody = document.getElementById('compsTable');
            tbody.innerHTML = companies.map(comp => `
                <tr class="border-b border-gray-800">
                    <td class="py-1.5">${comp.name}</td>
                    <td class="text-right py-1.5">${comp.evRevenue.toFixed(1)}x</td>
                    <td class="text-right py-1.5">${comp.evEbitda}x</td>
                    <td class="text-right py-1.5">${comp.pe}x</td>
                    <td class="text-right py-1.5">${comp.growth}%</td>
                </tr>
            `).join('');

            const multiples = companies.map(c => c.evRevenue).sort((a, b) => a - b);
            const median = multiples[Math.floor(multiples.length / 2)];
            const compsValuation = revenue * median;

            document.getElementById('medianMultiple').textContent = `${median.toFixed(1)}x`;
            document.getElementById('compsValuation').textContent = `$${formatNumber(compsValuation)}M`;
        }

        // Generate sensitivity table
        function generateSensitivity(revenue, growthRate, ebitdaMargin, terminalGrowth, wacc, taxRate) {
            const waccRange = [wacc - 0.02, wacc - 0.01, wacc, wacc + 0.01, wacc + 0.02];
            const terminalRange = [terminalGrowth - 0.02, terminalGrowth - 0.01, terminalGrowth, terminalGrowth + 0.01, terminalGrowth + 0.02];
            
            let tableHTML = '<table class="w-full text-xs"><thead><tr><th class="p-1 text-gray-400">WACC/Term</th>';
            terminalRange.forEach(t => {
                tableHTML += `<th class="p-1 text-gray-400 text-center">${(t * 100).toFixed(0)}%</th>`;
            });
            tableHTML += '</tr></thead><tbody>';

            waccRange.forEach(w => {
                tableHTML += `<tr><td class="p-1 text-gray-400">${(w * 100).toFixed(0)}%</td>`;
                terminalRange.forEach(t => {
                    if (t >= w) {
                        tableHTML += `<td class="p-1 text-center text-gray-600">-</td>`;
                    } else {
                        const fcf = revenue * (1 + growthRate) * ebitdaMargin * (1 - taxRate);
                        const tv = (fcf * Math.pow(1 + growthRate, 4) * (1 + t)) / (w - t);
                        const ev = tv / Math.pow(1 + w, 5) + fcf * 3;
                        
                        const isCenter = Math.abs(w - wacc) < 0.001 && Math.abs(t - terminalGrowth) < 0.001;
                        const color = ev > revenue * 5 ? 'text-emerald-400' : ev > revenue * 3 ? 'text-yellow-400' : 'text-red-400';
                        tableHTML += `<td class="p-1 text-center ${isCenter ? 'bg-white/20 font-bold' : ''} ${color}">$${Math.round(ev)}M</td>`;
                    }
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';

            document.getElementById('sensitivityTable').innerHTML = tableHTML;
        }

        // Event listeners
        document.getElementById('growthRate').addEventListener('input', function() {
            document.getElementById('growthRateValue').textContent = this.value + '%';
            calculateDCF();
        });

        document.getElementById('ebitdaMargin').addEventListener('input', function() {
            document.getElementById('ebitdaMarginValue').textContent = this.value + '%';
            calculateDCF();
        });

        document.getElementById('terminalGrowth').addEventListener('input', function() {
            document.getElementById('terminalGrowthValue').textContent = this.value + '%';
            calculateDCF();
        });

        document.getElementById('wacc').addEventListener('input', function() {
            document.getElementById('waccValue').textContent = this.value + '%';
            calculateDCF();
        });

        document.getElementById('taxRate').addEventListener('input', function() {
            document.getElementById('taxRateValue').textContent = this.value + '%';
            calculateDCF();
        });

        // Reset function
        function resetAssumptions() {
            document.getElementById('currentRevenue').value = 50;
            document.getElementById('growthRate').value = 25;
            document.getElementById('ebitdaMargin').value = 25;
            document.getElementById('terminalGrowth').value = 3;
            document.getElementById('wacc').value = 10;
            document.getElementById('taxRate').value = 21;
            
            document.getElementById('growthRateValue').textContent = '25%';
            document.getElementById('ebitdaMarginValue').textContent = '25%';
            document.getElementById('terminalGrowthValue').textContent = '3%';
            document.getElementById('waccValue').textContent = '10%';
            document.getElementById('taxRateValue').textContent = '21%';
            
            calculateDCF();
            setTimeout(() => lucide.createIcons(), 100);
        }

        // Export function
        function exportResults() {
            const data = {
                assumptions: {
                    revenue: document.getElementById('currentRevenue').value + 'M',
                    growthRate: document.getElementById('growthRate').value + '%',
                    ebitdaMargin: document.getElementById('ebitdaMargin').value + '%',
                    terminalGrowth: document.getElementById('terminalGrowth').value + '%',
                    wacc: document.getElementById('wacc').value + '%',
                    taxRate: document.getElementById('taxRate').value + '%'
                },
                valuation: {
                    enterpriseValue: document.getElementById('enterpriseValue').textContent,
                    evMultiple: document.getElementById('evMultiple').textContent,
                    terminalValue: document.getElementById('terminalValue').textContent
                }
            };
            
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'valuation-analysis.json';
            a.click();
            URL.revokeObjectURL(url);
            
            alert('Analysis exported! In production, this would generate an Excel model.');
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            
            // Delay chart initialization to ensure DOM is ready
            setTimeout(() => {
                initChart();
                calculateDCF();
            }, 100);
        });

        // Prevent any resize issues
        window.addEventListener('resize', function() {
            if (dcfChart) {
                // Don't resize, just update
                dcfChart.update('none');
            }
        });
    </script>
</body>
</html>
