<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget vs Actual Variance Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .favorable { color: #10b981; }
        .unfavorable { color: #ef4444; }
        .on-track { color: #3b82f6; }
        .variance-bar {
            height: 8px;
            border-radius: 4px;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
        }
        .variance-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .drill-down {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .drill-down:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateX(4px);
        }
        .threshold-warning {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .heatmap-cell {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .heatmap-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="glass-card rounded-xl p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent mb-2">
                        Budget vs Actual Variance Analysis
                    </h1>
                    <p class="text-gray-400">Real-time variance tracking with drill-down capabilities</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-400">YTD Performance</div>
                        <div id="ytdPerformance" class="text-2xl font-bold">--</div>
                    </div>
                    <button onclick="exportReport()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        Export Report
                    </button>
                </div>
            </div>

            <!-- Controls -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="text-sm text-gray-400 block mb-2">Period</label>
                    <select id="periodSelect" class="w-full bg-slate-800 text-white rounded-lg px-4 py-2 border border-gray-600">
                        <option value="current-month">October 2024</option>
                        <option value="last-month">September 2024</option>
                        <option value="quarter" selected>Q3 2024</option>
                        <option value="ytd">YTD 2024</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm text-gray-400 block mb-2">Department</label>
                    <select id="departmentSelect" class="w-full bg-slate-800 text-white rounded-lg px-4 py-2 border border-gray-600">
                        <option value="all">All Departments</option>
                        <option value="sales">Sales & Marketing</option>
                        <option value="rd">R&D</option>
                        <option value="ga">G&A</option>
                        <option value="ops">Operations</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm text-gray-400 block mb-2">View</label>
                    <div class="flex gap-2">
                        <button onclick="setView('summary')" class="view-btn px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm">Summary</button>
                        <button onclick="setView('detailed')" class="view-btn px-3 py-2 bg-slate-700 text-gray-300 rounded-lg text-sm">Detailed</button>
                        <button onclick="setView('heatmap')" class="view-btn px-3 py-2 bg-slate-700 text-gray-300 rounded-lg text-sm">Heatmap</button>
                    </div>
                </div>
                <div>
                    <label class="text-sm text-gray-400 block mb-2">Threshold</label>
                    <select id="thresholdSelect" class="w-full bg-slate-800 text-white rounded-lg px-4 py-2 border border-gray-600">
                        <option value="5">±5%</option>
                        <option value="10" selected>±10%</option>
                        <option value="15">±15%</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Summary View -->
            <div id="summaryView" class="lg:col-span-2">
                <!-- Executive Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4">
                        <h3 class="text-xs text-gray-400 mb-1">Total Budget</h3>
                        <div class="text-xl font-bold text-gray-200" id="totalBudget">--</div>
                    </div>
                    <div class="glass-card rounded-xl p-4">
                        <h3 class="text-xs text-gray-400 mb-1">Total Actual</h3>
                        <div class="text-xl font-bold text-gray-200" id="totalActual">--</div>
                    </div>
                    <div class="glass-card rounded-xl p-4">
                        <h3 class="text-xs text-gray-400 mb-1">Variance</h3>
                        <div class="text-xl font-bold" id="totalVariance">--</div>
                    </div>
                    <div class="glass-card rounded-xl p-4">
                        <h3 class="text-xs text-gray-400 mb-1">Variance %</h3>
                        <div class="text-xl font-bold" id="totalVariancePercent">--</div>
                    </div>
                </div>

                <!-- Variance Chart -->
                <div class="glass-card rounded-xl p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-200 mb-4">Variance by Category</h3>
                    <canvas id="varianceChart" width="400" height="200"></canvas>
                </div>

                <!-- Top Variances List -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-200 mb-4">Top Variances</h3>
                    <div id="topVariances" class="space-y-3">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

            <!-- Detailed View (Hidden by default) -->
            <div id="detailedView" class="lg:col-span-2 hidden">
                <div class="glass-card rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-200 mb-4">Detailed Variance Analysis</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-600">
                                    <th class="text-left py-3 px-2 text-gray-300">Account</th>
                                    <th class="text-right py-3 px-2 text-gray-300">Budget</th>
                                    <th class="text-right py-3 px-2 text-gray-300">Actual</th>
                                    <th class="text-right py-3 px-2 text-gray-300">Variance</th>
                                    <th class="text-right py-3 px-2 text-gray-300">Var %</th>
                                    <th class="text-center py-3 px-2 text-gray-300">Status</th>
                                </tr>
                            </thead>
                            <tbody id="detailedTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Heatmap View (Hidden by default) -->
            <div id="heatmapView" class="lg:col-span-2 hidden">
                <div class="glass-card rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-200 mb-4">Variance Heatmap</h3>
                    <div id="heatmapContainer" class="grid grid-cols-4 gap-2">
                        <!-- Dynamic heatmap cells -->
                    </div>
                </div>
            </div>

            <!-- Sidebar Analysis -->
            <div>
                <!-- Forecast Accuracy -->
                <div class="glass-card rounded-xl p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-200 mb-4">Forecast Accuracy</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-400">Revenue</span>
                                <span class="text-sm font-semibold" id="revenueAccuracy">--</span>
                            </div>
                            <div class="variance-bar">
                                <div id="revenueAccuracyBar" class="variance-fill bg-emerald-500"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-400">Operating Expenses</span>
                                <span class="text-sm font-semibold" id="opexAccuracy">--</span>
                            </div>
                            <div class="variance-bar">
                                <div id="opexAccuracyBar" class="variance-fill bg-blue-500"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-400">Capital Expenses</span>
                                <span class="text-sm font-semibold" id="capexAccuracy">--</span>
                            </div>
                            <div class="variance-bar">
                                <div id="capexAccuracyBar" class="variance-fill bg-purple-500"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Items -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-200 mb-4">Required Actions</h3>
                    <div id="actionItems" class="space-y-3">
                        <!-- Dynamic action items -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Trend Analysis -->
        <div class="glass-card rounded-xl p-6">
            <h3 class="text-lg font-semibold text-gray-200 mb-4">Variance Trend Analysis</h3>
            <canvas id="trendChart" width="400" height="200"></canvas>
        </div>
    </div>

    <script>
        // Budget and Actual Data
        const budgetData = {
            revenue: {
                'Product Sales': { budget: 3000000, actual: 3250000 },
                'Service Revenue': { budget: 1500000, actual: 1425000 },
                'Recurring Revenue': { budget: 2700000, actual: 2850000 },
                'Other Revenue': { budget: 100000, actual: 85000 }
            },
            opex: {
                'Sales & Marketing': {
                    'Salaries': { budget: 1200000, actual: 1250000 },
                    'Programs': { budget: 700000, actual: 680000 },
                    'Travel': { budget: 150000, actual: 120000 }
                },
                'R&D': {
                    'Engineering': { budget: 1800000, actual: 1850000 },
                    'Product Development': { budget: 400000, actual: 420000 },
                    'Patents': { budget: 100000, actual: 85000 }
                },
                'G&A': {
                    'Executive': { budget: 650000, actual: 650000 },
                    'Legal & Professional': { budget: 300000, actual: 280000 },
                    'Facilities': { budget: 350000, actual: 340000 },
                    'Insurance': { budget: 100000, actual: 95000 }
                }
            }
        };

        // Monthly trend data
        const trendData = {
            months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'],
            budgetCumulative: [650000, 1300000, 1950000, 2600000, 3250000, 3900000, 4550000, 5200000, 5850000],
            actualCumulative: [680000, 1340000, 2050000, 2700000, 3380000, 4020000, 4700000, 5360000, 6050000]
        };

        let varianceChart = null;
        let trendChart = null;
        let currentView = 'summary';

        function calculateVariance(budget, actual) {
            return actual - budget;
        }

        function calculateVariancePercent(budget, actual) {
            return budget !== 0 ? ((actual - budget) / budget * 100) : 0;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function updateDashboard() {
            const period = document.getElementById('periodSelect').value;
            const department = document.getElementById('departmentSelect').value;
            const threshold = parseInt(document.getElementById('thresholdSelect').value);
            
            // Calculate totals
            let totalBudget = 0;
            let totalActual = 0;
            
            // Revenue totals
            Object.values(budgetData.revenue).forEach(item => {
                totalBudget += item.budget;
                totalActual += item.actual;
            });
            
            // Expense totals
            Object.values(budgetData.opex).forEach(dept => {
                Object.values(dept).forEach(item => {
                    totalBudget += item.budget;
                    totalActual += item.actual;
                });
            });
            
            const totalVariance = calculateVariance(totalBudget, totalActual);
            const totalVariancePercent = calculateVariancePercent(totalBudget, totalActual);
            
            // Update summary cards
            document.getElementById('totalBudget').textContent = formatCurrency(totalBudget);
            document.getElementById('totalActual').textContent = formatCurrency(totalActual);
            document.getElementById('totalVariance').textContent = formatCurrency(Math.abs(totalVariance));
            document.getElementById('totalVariance').className = totalVariance >= 0 ? 'text-xl font-bold favorable' : 'text-xl font-bold unfavorable';
            document.getElementById('totalVariancePercent').textContent = totalVariancePercent.toFixed(1) + '%';
            document.getElementById('totalVariancePercent').className = totalVariance >= 0 ? 'text-xl font-bold favorable' : 'text-xl font-bold unfavorable';
            
            // Update YTD Performance
            const ytdVariance = ((6050000 / 5850000) - 1) * 100;
            document.getElementById('ytdPerformance').textContent = ytdVariance.toFixed(1) + '%';
            document.getElementById('ytdPerformance').className = ytdVariance >= 0 ? 'text-2xl font-bold favorable' : 'text-2xl font-bold unfavorable';
            
            // Update charts and views
            updateVarianceChart();
            updateTopVariances(threshold);
            updateForecastAccuracy();
            updateActionItems(threshold);
            updateTrendChart();
            
            if (currentView === 'detailed') {
                updateDetailedTable(threshold);
            } else if (currentView === 'heatmap') {
                updateHeatmap(threshold);
            }
        }

        function updateVarianceChart() {
            const ctx = document.getElementById('varianceChart').getContext('2d');
            
            if (varianceChart) {
                varianceChart.destroy();
            }
            
            const categories = [];
            const budgets = [];
            const actuals = [];
            
            // Add revenue
            let revenueBudget = 0;
            let revenueActual = 0;
            Object.values(budgetData.revenue).forEach(item => {
                revenueBudget += item.budget;
                revenueActual += item.actual;
            });
            categories.push('Revenue');
            budgets.push(revenueBudget);
            actuals.push(revenueActual);
            
            // Add departments
            Object.entries(budgetData.opex).forEach(([dept, items]) => {
                let deptBudget = 0;
                let deptActual = 0;
                Object.values(items).forEach(item => {
                    deptBudget += item.budget;
                    deptActual += item.actual;
                });
                categories.push(dept);
                budgets.push(deptBudget);
                actuals.push(deptActual);
            });
            
            varianceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Budget',
                        data: budgets,
                        backgroundColor: 'rgba(156, 163, 175, 0.5)',
                        borderColor: 'rgba(156, 163, 175, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Actual',
                        data: actuals,
                        backgroundColor: actuals.map((actual, i) => 
                            actual > budgets[i] ? 'rgba(16, 185, 129, 0.5)' : 'rgba(239, 68, 68, 0.5)'
                        ),
                        borderColor: actuals.map((actual, i) => 
                            actual > budgets[i] ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)'
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#9ca3af' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => '$' + (value / 1000000).toFixed(1) + 'M',
                                color: '#9ca3af'
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function updateTopVariances(threshold) {
            const variances = [];
            
            // Collect all variances
            Object.entries(budgetData.revenue).forEach(([name, data]) => {
                const variance = calculateVariance(data.budget, data.actual);
                const variancePercent = calculateVariancePercent(data.budget, data.actual);
                if (Math.abs(variancePercent) > threshold) {
                    variances.push({ name, variance, variancePercent, type: 'revenue' });
                }
            });
            
            Object.entries(budgetData.opex).forEach(([dept, items]) => {
                Object.entries(items).forEach(([name, data]) => {
                    const variance = calculateVariance(data.budget, data.actual);
                    const variancePercent = calculateVariancePercent(data.budget, data.actual);
                    if (Math.abs(variancePercent) > threshold) {
                        variances.push({ 
                            name: `${dept} - ${name}`, 
                            variance, 
                            variancePercent, 
                            type: 'expense' 
                        });
                    }
                });
            });
            
            // Sort by absolute variance
            variances.sort((a, b) => Math.abs(b.variance) - Math.abs(a.variance));
            
            // Display top 5
            const container = document.getElementById('topVariances');
            container.innerHTML = variances.slice(0, 5).map(item => `
                <div class="drill-down p-3 rounded-lg border border-gray-700">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-semibold text-gray-200">${item.name}</div>
                            <div class="text-xs text-gray-400">${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</div>
                        </div>
                        <div class="text-right">
                            <div class="${item.variance >= 0 ? 'favorable' : 'unfavorable'} font-semibold">
                                ${formatCurrency(Math.abs(item.variance))}
                            </div>
                            <div class="text-xs ${Math.abs(item.variancePercent) > threshold * 2 ? 'threshold-warning' : ''}">
                                ${item.variancePercent.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateForecastAccuracy() {
            // Revenue accuracy
            let revenueBudget = 0;
            let revenueActual = 0;
            Object.values(budgetData.revenue).forEach(item => {
                revenueBudget += item.budget;
                revenueActual += item.actual;
            });
            const revenueAccuracy = 100 - Math.abs(calculateVariancePercent(revenueBudget, revenueActual));
            
            document.getElementById('revenueAccuracy').textContent = revenueAccuracy.toFixed(1) + '%';
            document.getElementById('revenueAccuracyBar').style.width = revenueAccuracy + '%';
            
            // OpEx accuracy
            let opexBudget = 0;
            let opexActual = 0;
            Object.values(budgetData.opex).forEach(dept => {
                Object.values(dept).forEach(item => {
                    opexBudget += item.budget;
                    opexActual += item.actual;
                });
            });
            const opexAccuracy = 100 - Math.abs(calculateVariancePercent(opexBudget, opexActual));
            
            document.getElementById('opexAccuracy').textContent = opexAccuracy.toFixed(1) + '%';
            document.getElementById('opexAccuracyBar').style.width = opexAccuracy + '%';
            
            // CapEx accuracy (simulated)
            const capexAccuracy = 92.5;
            document.getElementById('capexAccuracy').textContent = capexAccuracy.toFixed(1) + '%';
            document.getElementById('capexAccuracyBar').style.width = capexAccuracy + '%';
        }

        function updateActionItems(threshold) {
            const actions = [];
            
            // Check for significant variances
            Object.entries(budgetData.opex).forEach(([dept, items]) => {
                Object.entries(items).forEach(([name, data]) => {
                    const variancePercent = calculateVariancePercent(data.budget, data.actual);
                    if (variancePercent > threshold) {
                        actions.push({
                            priority: 'high',
                            message: `Review ${dept} - ${name} overspend`,
                            amount: formatCurrency(data.actual - data.budget)
                        });
                    }
                });
            });
            
            // Add revenue concerns
            Object.entries(budgetData.revenue).forEach(([name, data]) => {
                const variancePercent = calculateVariancePercent(data.budget, data.actual);
                if (variancePercent < -threshold) {
                    actions.push({
                        priority: 'critical',
                        message: `Address ${name} shortfall`,
                        amount: formatCurrency(data.budget - data.actual)
                    });
                }
            });
            
            // Sort by priority
            actions.sort((a, b) => {
                const priorityOrder = { critical: 0, high: 1, medium: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            // Display actions
            const container = document.getElementById('actionItems');
            container.innerHTML = actions.slice(0, 4).map(action => `
                <div class="p-3 rounded-lg border ${
                    action.priority === 'critical' ? 'border-red-500/50 bg-red-900/20' :
                    action.priority === 'high' ? 'border-yellow-500/50 bg-yellow-900/20' :
                    'border-blue-500/50 bg-blue-900/20'
                }">
                    <div class="text-sm font-semibold text-gray-200">${action.message}</div>
                    <div class="text-xs text-gray-400 mt-1">Impact: ${action.amount}</div>
                </div>
            `).join('');
        }

        function updateTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.months,
                    datasets: [{
                        label: 'Cumulative Budget',
                        data: trendData.budgetCumulative,
                        borderColor: 'rgba(156, 163, 175, 1)',
                        backgroundColor: 'rgba(156, 163, 175, 0.1)',
                        borderDash: [5, 5],
                        tension: 0.4
                    }, {
                        label: 'Cumulative Actual',
                        data: trendData.actualCumulative,
                        borderColor: 'rgba(99, 102, 241, 1)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#9ca3af' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => '$' + (value / 1000000).toFixed(1) + 'M',
                                color: '#9ca3af'
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function updateDetailedTable(threshold) {
            const tbody = document.getElementById('detailedTableBody');
            tbody.innerHTML = '';
            
            // Add all items to table
            Object.entries(budgetData.revenue).forEach(([name, data]) => {
                addTableRow(tbody, name, data, 'Revenue', threshold);
            });
            
            Object.entries(budgetData.opex).forEach(([dept, items]) => {
                Object.entries(items).forEach(([name, data]) => {
                    addTableRow(tbody, `${dept} - ${name}`, data, 'Expense', threshold);
                });
            });
        }

        function addTableRow(tbody, name, data, type, threshold) {
            const variance = calculateVariance(data.budget, data.actual);
            const variancePercent = calculateVariancePercent(data.budget, data.actual);
            const isOverThreshold = Math.abs(variancePercent) > threshold;
            
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-700';
            row.innerHTML = `
                <td class="py-2 px-2 text-gray-300">${name}</td>
                <td class="text-right py-2 px-2">${formatCurrency(data.budget)}</td>
                <td class="text-right py-2 px-2">${formatCurrency(data.actual)}</td>
                <td class="text-right py-2 px-2 ${variance >= 0 ? 'favorable' : 'unfavorable'}">
                    ${formatCurrency(Math.abs(variance))}
                </td>
                <td class="text-right py-2 px-2 ${variance >= 0 ? 'favorable' : 'unfavorable'}">
                    ${variancePercent.toFixed(1)}%
                </td>
                <td class="text-center py-2 px-2">
                    <span class="px-2 py-1 rounded text-xs ${
                        isOverThreshold ? 'bg-red-900/50 text-red-400' : 'bg-green-900/50 text-green-400'
                    }">
                        ${isOverThreshold ? 'Review' : 'OK'}
                    </span>
                </td>
            `;
            tbody.appendChild(row);
        }

        function updateHeatmap(threshold) {
            const container = document.getElementById('heatmapContainer');
            container.innerHTML = '';
            
            const allItems = [];
            
            // Collect all items
            Object.entries(budgetData.revenue).forEach(([name, data]) => {
                const variancePercent = calculateVariancePercent(data.budget, data.actual);
                allItems.push({ name, variancePercent, type: 'Revenue' });
            });
            
            Object.entries(budgetData.opex).forEach(([dept, items]) => {
                Object.entries(items).forEach(([name, data]) => {
                    const variancePercent = calculateVariancePercent(data.budget, data.actual);
                    allItems.push({ name: `${dept} - ${name}`, variancePercent, type: dept });
                });
            });
            
            // Create heatmap cells
            allItems.forEach(item => {
                const intensity = Math.min(Math.abs(item.variancePercent) / 30, 1);
                const color = item.variancePercent >= 0 
                    ? `rgba(16, 185, 129, ${intensity})` 
                    : `rgba(239, 68, 68, ${intensity})`;
                
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell p-4 rounded-lg border border-gray-700 text-center';
                cell.style.backgroundColor = color;
                cell.innerHTML = `
                    <div class="text-xs font-semibold text-white">${item.name}</div>
                    <div class="text-lg font-bold mt-1">${item.variancePercent.toFixed(1)}%</div>
                `;
                container.appendChild(cell);
            });
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-slate-700', 'text-gray-300');
            });
            event.target.classList.remove('bg-slate-700', 'text-gray-300');
            event.target.classList.add('bg-indigo-600', 'text-white');
            
            document.getElementById('summaryView').classList.toggle('hidden', view !== 'summary');
            document.getElementById('detailedView').classList.toggle('hidden', view !== 'detailed');
            document.getElementById('heatmapView').classList.toggle('hidden', view !== 'heatmap');
            
            if (view === 'detailed') {
                updateDetailedTable(parseInt(document.getElementById('thresholdSelect').value));
            } else if (view === 'heatmap') {
                updateHeatmap(parseInt(document.getElementById('thresholdSelect').value));
            }
        }

        function exportReport() {
            alert('Report export functionality would generate PDF/Excel report with current view data');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDashboard();
            
            // Add event listeners
            document.getElementById('periodSelect').addEventListener('change', updateDashboard);
            document.getElementById('departmentSelect').addEventListener('change', updateDashboard);
            document.getElementById('thresholdSelect').addEventListener('change', updateDashboard);
        });
    </script>
</body>
</html>
