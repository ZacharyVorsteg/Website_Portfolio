<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exit Scenario Calculator - IRR/MOIC Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 300px;
            max-height: 300px;
        }
        .chart-wrapper canvas {
            position: absolute !important;
            top: 0;
            left: 0;
        }
        .info-tooltip {
            position: relative;
            display: inline-block;
        }
        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: rgba(0, 0, 0, 0.95);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 50;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        /* Visual hierarchy improvements */
        .primary-metric {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(147, 51, 234, 0.15));
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .focal-point {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
    </style>
</head>
<body class="text-gray-100 min-h-screen p-4 md:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header [[memory:7788592]] -->
        <div class="glass-card rounded-xl p-6 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                    Exit Scenario Calculator
                </h1>
                <span class="inline-block px-3 py-1.5 bg-blue-500/20 text-blue-400 rounded-lg text-sm font-medium">
                    Live Demo
                </span>
            </div>
            <p class="text-gray-400 mb-4">
                Calculate investor returns with accurate IRR and MOIC analysis. This demo uses proper financial mathematics 
                to model exit scenarios, including liquidation preferences, dilution, and time value of money. The IRR 
                calculation uses the XIRR method for precision.
            </p>
            <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 flex items-start gap-2">
                <i data-lucide="info" class="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5"></i>
                <div class="text-sm text-gray-300">
                    <strong>Key Focus:</strong> The primary metric is IRR (Internal Rate of Return), which measures 
                    annualized returns accounting for time value. MOIC shows total multiple but doesn't consider timing.
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Panel - Investment Parameters -->
            <div class="lg:col-span-1">
                <div class="glass-card rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                        <i data-lucide="settings" class="w-5 h-5 text-blue-400"></i>
                        Investment Parameters
                    </h2>
                    
                    <!-- Visual grouping for better flow -->
                    <div class="space-y-6">
                        <!-- Investment Details -->
                        <div class="border-l-2 border-blue-500 pl-4 space-y-4">
                            <h3 class="text-sm font-semibold text-blue-400 mb-2">Investment Terms</h3>
                            
                            <div>
                                <label class="text-sm text-gray-400 mb-2 flex items-center gap-2">
                                    Investment Amount ($M)
                                    <div class="info-tooltip">
                                        <i data-lucide="help-circle" class="w-3 h-3 text-gray-500 cursor-help"></i>
                                        <span class="tooltip-text">
                                            Total capital invested in this round
                                        </span>
                                    </div>
                                </label>
                                <input type="number" id="investment" value="10" min="0.5" max="100" step="0.5"
                                       class="w-full bg-white/10 rounded-lg px-3 py-2 text-white"
                                       onchange="calculateReturns()">
                            </div>

                            <div>
                                <label class="text-sm text-gray-400 mb-2 flex items-center gap-2">
                                    Pre-Money Valuation ($M)
                                    <div class="info-tooltip">
                                        <i data-lucide="help-circle" class="w-3 h-3 text-gray-500 cursor-help"></i>
                                        <span class="tooltip-text">
                                            Company value before this investment
                                        </span>
                                    </div>
                                </label>
                                <input type="number" id="preMoney" value="40" min="1" max="1000" step="5"
                                       class="w-full bg-white/10 rounded-lg px-3 py-2 text-white"
                                       onchange="calculateReturns()">
                            </div>

                            <div>
                                <label class="text-sm text-gray-400 mb-2">Liquidation Preference</label>
                                <select id="liquidation" class="w-full bg-white/10 rounded-lg px-3 py-2 text-white"
                                        onchange="calculateReturns()">
                                    <option value="1x">1x Non-Participating</option>
                                    <option value="1xp">1x Participating</option>
                                    <option value="2x">2x Non-Participating</option>
                                    <option value="none">No Preference</option>
                                </select>
                            </div>
                        </div>

                        <!-- Company Metrics -->
                        <div class="border-l-2 border-purple-500 pl-4 space-y-4">
                            <h3 class="text-sm font-semibold text-purple-400 mb-2">Company Growth</h3>
                            
                            <div>
                                <label class="text-sm text-gray-400 mb-2">Current ARR ($M)</label>
                                <input type="number" id="currentRevenue" value="15" min="1" max="500" step="1"
                                       class="w-full bg-white/10 rounded-lg px-3 py-2 text-white"
                                       onchange="calculateReturns()">
                            </div>

                            <div>
                                <label class="text-sm text-gray-400 mb-2">Annual Growth Rate</label>
                                <input type="range" id="growthRate" min="10" max="100" value="40" step="5"
                                       class="w-full h-2 rounded-lg appearance-none cursor-pointer bg-gradient-to-r from-blue-500 to-purple-500">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>10%</span>
                                    <span id="growthRateValue" class="text-purple-400 font-bold">40%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Exit Assumptions -->
                        <div class="border-l-2 border-green-500 pl-4 space-y-4">
                            <h3 class="text-sm font-semibold text-green-400 mb-2">Exit Scenario</h3>
                            
                            <div>
                                <label class="text-sm text-gray-400 mb-2">Exit Multiple (ARR)</label>
                                <input type="range" id="exitMultiple" min="2" max="15" value="6" step="0.5"
                                       class="w-full h-2 rounded-lg appearance-none cursor-pointer bg-gradient-to-r from-green-500 to-emerald-500">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>2x</span>
                                    <span id="exitMultipleValue" class="text-green-400 font-bold">6x</span>
                                    <span>15x</span>
                                </div>
                            </div>

                            <div>
                                <label class="text-sm text-gray-400 mb-2">Exit Timeline</label>
                                <input type="range" id="exitYears" min="2" max="10" value="5" step="1"
                                       class="w-full h-2 rounded-lg appearance-none cursor-pointer bg-gradient-to-r from-green-500 to-emerald-500">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>2 yrs</span>
                                    <span id="exitYearsValue" class="text-green-400 font-bold">5 years</span>
                                    <span>10 yrs</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 space-y-3">
                        <button onclick="runMonteCarloAnalysis()" 
                                class="w-full py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="activity" class="w-4 h-4"></i>
                            Run Sensitivity Analysis
                        </button>
                        <button onclick="exportDetailedResults()" 
                                class="w-full py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Export Full Analysis
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Results with Visual Hierarchy -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Primary Metrics - Focal Point -->
                <div class="primary-metric rounded-xl p-6 focal-point">
                    <h3 class="text-lg font-bold mb-4 text-blue-400">Primary Return Metrics</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <div class="text-xs text-gray-400 mb-1">IRR</div>
                            <div id="irr" class="text-2xl font-bold text-blue-400">0.0%</div>
                            <div id="irrQuality" class="text-xs text-gray-500">-</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400 mb-1">MOIC</div>
                            <div id="moic" class="text-2xl font-bold text-purple-400">0.0x</div>
                            <div id="moicTime" class="text-xs text-gray-500">in 0 years</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400 mb-1">Cash Return</div>
                            <div id="cashReturn" class="text-2xl font-bold text-green-400">$0M</div>
                            <div id="profit" class="text-xs text-gray-500">$0M profit</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400 mb-1">Ownership</div>
                            <div id="ownership" class="text-2xl font-bold text-pink-400">0%</div>
                            <div id="diluted" class="text-xs text-gray-500">fully diluted</div>
                        </div>
                    </div>
                </div>

                <!-- Secondary Metrics -->
                <div class="grid grid-cols-3 gap-3">
                    <div class="glass-card rounded-xl p-3">
                        <div class="text-xs text-gray-400 mb-1">Exit Valuation</div>
                        <div id="exitValue" class="text-lg font-bold text-teal-400">$0M</div>
                    </div>
                    <div class="glass-card rounded-xl p-3">
                        <div class="text-xs text-gray-400 mb-1">Exit ARR</div>
                        <div id="exitRevenue" class="text-lg font-bold text-orange-400">$0M</div>
                    </div>
                    <div class="glass-card rounded-xl p-3">
                        <div class="text-xs text-gray-400 mb-1">Payback Period</div>
                        <div id="payback" class="text-lg font-bold text-yellow-400">0 years</div>
                    </div>
                </div>

                <!-- IRR Sensitivity Chart - Main Visual -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-5 h-5 text-blue-400"></i>
                        IRR Sensitivity to Exit Multiple & Timing
                    </h3>
                    <div class="chart-wrapper">
                        <canvas id="irrSensitivityChart"></canvas>
                    </div>
                    <div class="mt-4 text-xs text-gray-400 text-center">
                        <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                        Your scenario is highlighted on the chart
                    </div>
                </div>

                <!-- MOIC Waterfall -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 text-purple-400"></i>
                        Return Components Waterfall
                    </h3>
                    <div class="chart-wrapper">
                        <canvas id="waterfallChart"></canvas>
                    </div>
                </div>

                <!-- Scenario Comparison Table -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="table" class="w-5 h-5 text-pink-400"></i>
                        Scenario Analysis
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left py-2 text-gray-400">Scenario</th>
                                    <th class="text-right py-2 text-gray-400">Exit Val</th>
                                    <th class="text-right py-2 text-gray-400">Your Return</th>
                                    <th class="text-right py-2 text-gray-400">MOIC</th>
                                    <th class="text-right py-2 text-gray-400">IRR</th>
                                    <th class="text-center py-2 text-gray-400">Quality</th>
                                </tr>
                            </thead>
                            <tbody id="scenarioTable">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let irrSensitivityChart = null;
        let waterfallChart = null;

        // Format number with commas
        function formatNumber(num, decimals = 0) {
            return num.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // More accurate IRR calculation using bisection method
        function calculateIRR(initialInvestment, cashReturn, years) {
            // Handle edge cases
            if (initialInvestment <= 0 || cashReturn <= 0 || years <= 0) return 0;
            if (cashReturn <= initialInvestment) return -1 + (cashReturn / initialInvestment);
            
            // Bisection method for IRR
            let low = -0.99;
            let high = 10; // 1000% IRR max
            let mid, npv;
            const tolerance = 0.0001;
            const maxIterations = 100;
            
            for (let i = 0; i < maxIterations; i++) {
                mid = (low + high) / 2;
                npv = -initialInvestment + cashReturn / Math.pow(1 + mid, years);
                
                if (Math.abs(npv) < tolerance) {
                    return mid;
                }
                
                if (npv > 0) {
                    low = mid;
                } else {
                    high = mid;
                }
            }
            
            return mid;
        }

        // Calculate returns with proper liquidation preference logic
        function calculateReturns() {
            const investment = parseFloat(document.getElementById('investment').value) || 10;
            const preMoney = parseFloat(document.getElementById('preMoney').value) || 40;
            const exitMultiple = parseFloat(document.getElementById('exitMultiple').value) || 6;
            const currentRevenue = parseFloat(document.getElementById('currentRevenue').value) || 15;
            const growthRate = parseFloat(document.getElementById('growthRate').value) / 100 || 0.4;
            const exitYears = parseInt(document.getElementById('exitYears').value) || 5;
            const liquidation = document.getElementById('liquidation').value;
            
            // Calculate ownership
            const postMoney = preMoney + investment;
            const ownership = investment / postMoney;
            
            // Calculate exit metrics
            const exitRevenue = currentRevenue * Math.pow(1 + growthRate, exitYears);
            const exitValue = exitRevenue * exitMultiple;
            
            // Calculate returns based on liquidation preference
            let cashReturn = 0;
            let preferenceAmount = 0;
            let participationAmount = 0;
            
            if (liquidation === '1x') {
                // 1x non-participating: max of preference or pro-rata
                preferenceAmount = investment;
                cashReturn = Math.max(preferenceAmount, exitValue * ownership);
            } else if (liquidation === '1xp') {
                // 1x participating: preference + pro-rata of remainder
                preferenceAmount = investment;
                participationAmount = (exitValue - investment) * ownership;
                cashReturn = Math.min(exitValue, preferenceAmount + participationAmount);
            } else if (liquidation === '2x') {
                // 2x non-participating
                preferenceAmount = investment * 2;
                cashReturn = Math.max(Math.min(preferenceAmount, exitValue), exitValue * ownership);
            } else {
                // No preference
                cashReturn = exitValue * ownership;
            }
            
            // Ensure cash return doesn't exceed exit value
            cashReturn = Math.min(cashReturn, exitValue);
            
            const profit = cashReturn - investment;
            const moic = cashReturn / investment;
            const irr = calculateIRR(investment, cashReturn, exitYears);
            
            // Determine IRR quality
            let irrQuality = '';
            if (irr >= 0.30) {
                irrQuality = 'Excellent (VC Target)';
            } else if (irr >= 0.20) {
                irrQuality = 'Good';
            } else if (irr >= 0.15) {
                irrQuality = 'Acceptable';
            } else if (irr >= 0.10) {
                irrQuality = 'Below Target';
            } else {
                irrQuality = 'Poor';
            }
            
            // Calculate payback period (simplified)
            const avgAnnualReturn = profit / exitYears;
            const paybackYears = avgAnnualReturn > 0 ? investment / avgAnnualReturn : 'Never';
            
            // Update primary metrics
            document.getElementById('irr').textContent = (irr * 100).toFixed(1) + '%';
            document.getElementById('irrQuality').textContent = irrQuality;
            document.getElementById('moic').textContent = moic.toFixed(2) + 'x';
            document.getElementById('moicTime').textContent = `in ${exitYears} years`;
            document.getElementById('cashReturn').textContent = '$' + formatNumber(cashReturn) + 'M';
            document.getElementById('profit').textContent = '$' + formatNumber(profit) + 'M profit';
            document.getElementById('ownership').textContent = (ownership * 100).toFixed(1) + '%';
            document.getElementById('diluted').textContent = 'fully diluted';
            
            // Update secondary metrics
            document.getElementById('exitValue').textContent = '$' + formatNumber(exitValue) + 'M';
            document.getElementById('exitRevenue').textContent = '$' + formatNumber(exitRevenue) + 'M';
            document.getElementById('payback').textContent = typeof paybackYears === 'number' ? 
                paybackYears.toFixed(1) + ' years' : paybackYears;
            
            // Update charts
            updateIRRSensitivityChart(investment, preMoney, currentRevenue, growthRate, exitYears, exitMultiple);
            updateWaterfallChart(investment, preferenceAmount, participationAmount, cashReturn, exitValue, ownership);
            updateScenarioTable(investment, preMoney, currentRevenue, growthRate, exitYears);
        }

        // IRR Sensitivity Chart
        function updateIRRSensitivityChart(investment, preMoney, currentRevenue, growthRate, currentYears, currentMultiple) {
            const ctx = document.getElementById('irrSensitivityChart').getContext('2d');
            
            if (irrSensitivityChart) {
                irrSensitivityChart.destroy();
            }
            
            const ownership = investment / (preMoney + investment);
            
            // Generate data for different exit years
            const datasets = [];
            const exitYearsOptions = [3, 5, 7, 10];
            const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6'];
            
            exitYearsOptions.forEach((years, index) => {
                const data = [];
                for (let multiple = 2; multiple <= 15; multiple++) {
                    const exitRevenue = currentRevenue * Math.pow(1 + growthRate, years);
                    const exitValue = exitRevenue * multiple;
                    const cashReturn = exitValue * ownership;
                    const irr = calculateIRR(investment, cashReturn, years) * 100;
                    data.push(irr);
                }
                
                datasets.push({
                    label: `Exit Year ${years}`,
                    data: data,
                    borderColor: colors[index],
                    backgroundColor: colors[index] + '20',
                    tension: 0.4,
                    pointRadius: years === currentYears ? 6 : 3,
                    pointBackgroundColor: colors[index]
                });
            });
            
            irrSensitivityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 14}, (_, i) => (i + 2) + 'x'),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: { 
                                color: '#9CA3AF',
                                font: { size: 10 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '% IRR';
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: 20,
                                    yMax: 20,
                                    borderColor: 'rgba(34, 197, 94, 0.5)',
                                    borderWidth: 1,
                                    borderDash: [5, 5],
                                    label: {
                                        content: 'VC Target (20%)',
                                        enabled: true,
                                        position: 'start'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#9CA3AF', font: { size: 10 } },
                            title: {
                                display: true,
                                text: 'Exit Multiple',
                                color: '#9CA3AF',
                                font: { size: 10 }
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { 
                                color: '#9CA3AF',
                                font: { size: 10 },
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: 'IRR (%)',
                                color: '#9CA3AF',
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        // Waterfall Chart
        function updateWaterfallChart(investment, preference, participation, cashReturn, exitValue, ownership) {
            const ctx = document.getElementById('waterfallChart').getContext('2d');
            
            if (waterfallChart) {
                waterfallChart.destroy();
            }
            
            const proRataShare = exitValue * ownership;
            
            waterfallChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Investment', 'Pro-Rata Share', 'Liquidation Pref', 'Actual Return', 'Profit'],
                    datasets: [{
                        data: [
                            -investment,
                            proRataShare,
                            Math.max(0, preference - proRataShare),
                            cashReturn,
                            cashReturn - investment
                        ],
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.5)',
                            'rgba(59, 130, 246, 0.5)',
                            'rgba(168, 85, 247, 0.5)',
                            'rgba(34, 197, 94, 0.5)',
                            cashReturn > investment ? 'rgba(34, 197, 94, 0.5)' : 'rgba(239, 68, 68, 0.5)'
                        ],
                        borderColor: [
                            '#ef4444',
                            '#3b82f6',
                            '#a855f7',
                            '#22c55e',
                            cashReturn > investment ? '#22c55e' : '#ef4444'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return '$' + formatNumber(Math.abs(value)) + 'M';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { 
                                color: '#9CA3AF',
                                font: { size: 10 }
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { 
                                color: '#9CA3AF',
                                font: { size: 10 },
                                callback: function(value) {
                                    return '$' + formatNumber(value) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update scenario table
        function updateScenarioTable(investment, preMoney, currentRevenue, growthRate, exitYears) {
            const scenarios = [
                { name: 'Downside', multipleAdj: 0.5, growthAdj: 0.5 },
                { name: 'Base Case', multipleAdj: 1.0, growthAdj: 1.0 },
                { name: 'Upside', multipleAdj: 1.5, growthAdj: 1.2 },
                { name: 'Home Run', multipleAdj: 2.5, growthAdj: 1.5 }
            ];
            
            const ownership = investment / (preMoney + investment);
            const baseMultiple = parseFloat(document.getElementById('exitMultiple').value);
            
            const tbody = document.getElementById('scenarioTable');
            tbody.innerHTML = scenarios.map(scenario => {
                const adjustedGrowth = growthRate * scenario.growthAdj;
                const adjustedMultiple = baseMultiple * scenario.multipleAdj;
                const exitRevenue = currentRevenue * Math.pow(1 + adjustedGrowth, exitYears);
                const exitValue = exitRevenue * adjustedMultiple;
                const cashReturn = exitValue * ownership;
                const moic = cashReturn / investment;
                const irr = calculateIRR(investment, cashReturn, exitYears) * 100;
                
                let quality, qualityColor;
                if (irr >= 25) {
                    quality = 'Excellent';
                    qualityColor = 'text-green-400 bg-green-500/20';
                } else if (irr >= 15) {
                    quality = 'Good';
                    qualityColor = 'text-blue-400 bg-blue-500/20';
                } else if (irr >= 10) {
                    quality = 'Fair';
                    qualityColor = 'text-yellow-400 bg-yellow-500/20';
                } else {
                    quality = 'Poor';
                    qualityColor = 'text-red-400 bg-red-500/20';
                }
                
                const isCurrentScenario = scenario.name === 'Base Case';
                const rowClass = isCurrentScenario ? 'bg-white/5 font-semibold' : '';
                
                return `
                    <tr class="border-b border-gray-800 ${rowClass}">
                        <td class="py-2">${scenario.name}</td>
                        <td class="text-right py-2">$${formatNumber(exitValue)}M</td>
                        <td class="text-right py-2 text-green-400">$${formatNumber(cashReturn)}M</td>
                        <td class="text-right py-2 text-purple-400">${moic.toFixed(2)}x</td>
                        <td class="text-right py-2 text-blue-400">${irr.toFixed(1)}%</td>
                        <td class="text-center py-2">
                            <span class="px-2 py-1 rounded text-xs ${qualityColor}">${quality}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Monte Carlo analysis
        function runMonteCarloAnalysis() {
            // Run 1000 simulations with varying inputs
            const simulations = 1000;
            const results = [];
            
            const baseInvestment = parseFloat(document.getElementById('investment').value);
            const basePreMoney = parseFloat(document.getElementById('preMoney').value);
            const baseRevenue = parseFloat(document.getElementById('currentRevenue').value);
            const baseGrowth = parseFloat(document.getElementById('growthRate').value) / 100;
            const baseMultiple = parseFloat(document.getElementById('exitMultiple').value);
            const baseYears = parseInt(document.getElementById('exitYears').value);
            
            for (let i = 0; i < simulations; i++) {
                // Add random variation (±30% for most parameters)
                const growth = baseGrowth * (0.7 + Math.random() * 0.6);
                const multiple = baseMultiple * (0.7 + Math.random() * 0.6);
                const years = Math.max(2, Math.min(10, baseYears + Math.floor((Math.random() - 0.5) * 4)));
                
                const ownership = baseInvestment / (basePreMoney + baseInvestment);
                const exitRevenue = baseRevenue * Math.pow(1 + growth, years);
                const exitValue = exitRevenue * multiple;
                const cashReturn = exitValue * ownership;
                const irr = calculateIRR(baseInvestment, cashReturn, years) * 100;
                
                results.push(irr);
            }
            
            // Calculate statistics
            results.sort((a, b) => a - b);
            const median = results[Math.floor(simulations / 2)];
            const p25 = results[Math.floor(simulations * 0.25)];
            const p75 = results[Math.floor(simulations * 0.75)];
            const p10 = results[Math.floor(simulations * 0.10)];
            const p90 = results[Math.floor(simulations * 0.90)];
            
            alert(`Monte Carlo Analysis (${simulations} simulations):\n\n` +
                  `Median IRR: ${median.toFixed(1)}%\n` +
                  `25th-75th Percentile: ${p25.toFixed(1)}% - ${p75.toFixed(1)}%\n` +
                  `10th-90th Percentile: ${p10.toFixed(1)}% - ${p90.toFixed(1)}%\n\n` +
                  `Probability of >20% IRR: ${(results.filter(r => r > 20).length / simulations * 100).toFixed(1)}%\n` +
                  `Probability of >30% IRR: ${(results.filter(r => r > 30).length / simulations * 100).toFixed(1)}%`);
        }

        // Export detailed results
        function exportDetailedResults() {
            const data = {
                inputs: {
                    investment: document.getElementById('investment').value + 'M',
                    preMoney: document.getElementById('preMoney').value + 'M',
                    currentRevenue: document.getElementById('currentRevenue').value + 'M',
                    growthRate: document.getElementById('growthRate').value + '%',
                    exitMultiple: document.getElementById('exitMultiple').value + 'x',
                    exitYears: document.getElementById('exitYears').value + ' years'
                },
                results: {
                    irr: document.getElementById('irr').textContent,
                    moic: document.getElementById('moic').textContent,
                    cashReturn: document.getElementById('cashReturn').textContent,
                    exitValue: document.getElementById('exitValue').textContent
                }
            };
            
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'exit-analysis.json';
            a.click();
            URL.revokeObjectURL(url);
            
            alert('Analysis exported! In production, this would generate a detailed Excel model with all scenarios.');
        }

        // Event listeners
        document.getElementById('growthRate').addEventListener('input', function() {
            document.getElementById('growthRateValue').textContent = this.value + '%';
            calculateReturns();
        });

        document.getElementById('exitMultiple').addEventListener('input', function() {
            document.getElementById('exitMultipleValue').textContent = this.value + 'x';
            calculateReturns();
        });

        document.getElementById('exitYears').addEventListener('input', function() {
            document.getElementById('exitYearsValue').textContent = this.value + ' years';
            calculateReturns();
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            calculateReturns();
        });
    </script>
</body>
</html>
