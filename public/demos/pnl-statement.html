<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive P&L Statement - CFO Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .account-row {
            transition: all 0.2s ease;
        }
        .account-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .expandable {
            cursor: pointer;
            user-select: none;
        }
        .child-account {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .expanded .child-account {
            display: table-row;
            opacity: 1;
        }
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .negative-value { color: #ef4444; }
        .positive-variance { color: #10b981; }
        .negative-variance { color: #ef4444; }
        .editable-value {
            cursor: pointer;
            text-decoration: underline dotted;
            text-underline-offset: 2px;
            transition: all 0.2s ease;
        }
        .editable-value:hover {
            background: rgba(59, 130, 246, 0.2);
            border-radius: 4px;
            padding: 0 4px;
            margin: 0 -4px;
        }
        .editing-input {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #3b82f6;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            width: 120px;
        }
        .delta-indicator {
            font-size: 11px;
            margin-left: 4px;
            font-weight: normal;
        }
        .scenario-button {
            transition: all 0.2s ease;
        }
        .scenario-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .number-transition {
            transition: all 0.3s ease;
        }
        .warning-banner {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        .info-tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: rgba(0, 0, 0, 0.9);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .insights-box {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .insights-box.expanded {
            max-height: 200px;
        }
        .month-view {
            display: none;
        }
        .month-view.active {
            display: block;
        }
        .standard-view.hidden {
            display: none;
        }
        
        /* 12-Month Table Styles */
        .monthly-pnl-table {
            border-collapse: separate;
            border-spacing: 0;
        }
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .sticky-column {
            position: sticky;
            left: 0;
            z-index: 10;
            background: #0f172a !important;
            min-width: 150px;
        }
        .monthly-pnl-table tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }
        .monthly-pnl-table tbody tr {
            min-height: 36px;
        }
        .editable-cell {
            cursor: pointer;
            position: relative;
        }
        .editable-cell:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        .edited-cell {
            border: 1px solid #fbbf24 !important;
        }
        .variance-high-positive {
            color: #10b981;
            opacity: 1;
        }
        .variance-med-positive {
            color: #10b981;
            opacity: 0.75;
        }
        .variance-low-positive {
            color: #10b981;
            opacity: 0.5;
        }
        .variance-high-negative {
            color: #ef4444;
            opacity: 1;
        }
        .variance-med-negative {
            color: #ef4444;
            opacity: 0.75;
        }
        .variance-low-negative {
            color: #ef4444;
            opacity: 0.5;
        }
        .section-divider {
            border-top: 2px solid #4b5563;
            border-bottom: 2px solid #4b5563;
        }
        .sub-account {
            padding-left: 20px !important;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Warning Banner -->
        <div id="warningBanner" class="warning-banner bg-yellow-900/50 border border-yellow-500/50 rounded-lg p-4 mb-6 flex items-center gap-3">
            <span class="text-2xl">‚ö†Ô∏è</span>
            <span class="text-yellow-200 text-sm font-medium">
                Operating Expenses (<span id="opexAmount">$5.77M</span>) exceed Gross Profit (<span id="grossProfitAmount">$5.60M</span>) by <span id="lossAmount">$170k</span> - Reduce OpEx by 3% to break even
            </span>
        </div>

        <!-- Header with controls -->
        <div class="glass-card rounded-xl p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-emerald-400 to-teal-400 bg-clip-text text-transparent mb-2">
                        Income Statement (P&L)
                    </h1>
                    <p class="text-gray-400">Click revenue or expenses to edit ‚Ä¢ Expand categories for details</p>
                </div>
                <div class="info-tooltip">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="tooltip-text">
                        Click on Revenue or OpEx values to edit and see real-time impact. 
                        Click arrows to expand categories. Try scenario buttons for quick analysis.
                    </span>
                </div>
            </div>

            <!-- Scenario Buttons -->
            <div class="flex flex-wrap gap-3 mb-6">
                <button onclick="applyScenario('growth')" class="scenario-button px-4 py-2 bg-emerald-600 text-white rounded-lg flex items-center gap-2">
                    üìà Growth Case (+15%)
                </button>
                <button onclick="applyScenario('cost-cut')" class="scenario-button px-4 py-2 bg-orange-600 text-white rounded-lg flex items-center gap-2">
                    ‚úÇÔ∏è Cut Costs (-10%)
                </button>
                <button onclick="resetValues()" id="resetButton" class="scenario-button px-4 py-2 bg-slate-600 text-white rounded-lg flex items-center gap-2 hidden">
                    üîÑ Reset to Original
                </button>
                <button onclick="toggleMonthView()" class="scenario-button px-4 py-2 bg-purple-600 text-white rounded-lg flex items-center gap-2">
                    üìä Toggle 12-Month View
                </button>
            </div>

            <!-- Period Selector and Controls -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="text-sm text-gray-400 block mb-2">Reporting Period</label>
                    <select id="periodSelect" class="w-full bg-slate-800 text-white rounded-lg px-4 py-2 border border-gray-600">
                        <option value="q1">Q1 2024</option>
                        <option value="q2">Q2 2024</option>
                        <option value="q3" selected>Q3 2024</option>
                        <option value="ytd">YTD 2024</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm text-gray-400 block mb-2">Comparison</label>
                    <select id="comparisonSelect" class="w-full bg-slate-800 text-white rounded-lg px-4 py-2 border border-gray-600">
                        <option value="budget">vs Budget</option>
                        <option value="prior">vs Prior Year</option>
                        <option value="forecast">vs Forecast</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm text-gray-400 block mb-2">View</label>
                    <div class="flex gap-2">
                        <button onclick="toggleView('table')" class="view-btn px-4 py-2 bg-emerald-600 text-white rounded-lg">Table</button>
                        <button onclick="toggleView('waterfall')" class="view-btn px-4 py-2 bg-slate-700 text-gray-300 rounded-lg">Waterfall</button>
                        <button onclick="toggleView('trend')" class="view-btn px-4 py-2 bg-slate-700 text-gray-300 rounded-lg">Trend</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main P&L Table -->
        <div id="tableView" class="standard-view glass-card rounded-xl p-6 mb-6">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-600">
                            <th class="text-left py-3 px-2 text-gray-300">Account</th>
                            <th class="text-right py-3 px-2 text-gray-300">Actual</th>
                            <th class="text-right py-3 px-2 text-gray-300">Budget</th>
                            <th class="text-right py-3 px-2 text-gray-300">Variance</th>
                            <th class="text-right py-3 px-2 text-gray-300">Var %</th>
                            <th class="text-right py-3 px-2 text-gray-300">% of Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="pnlTableBody">
                        <!-- Dynamic content will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Smart Insights Box -->
            <div class="mt-4">
                <button onclick="toggleInsights()" class="text-sm text-gray-400 hover:text-white flex items-center gap-2">
                    <span id="insightsToggle">‚ñ∂</span> Smart Insights
                </button>
                <div id="insightsBox" class="insights-box mt-3">
                    <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                        <ul class="space-y-2">
                            <li class="flex items-start gap-2">
                                <span class="text-red-500 mt-0.5">‚óè</span>
                                <span class="text-gray-300 text-sm">Burn rate: <span id="burnRate" class="font-semibold text-red-400">$68.7k/month</span> at current loss level</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-yellow-500 mt-0.5">‚óè</span>
                                <span class="text-gray-300 text-sm">Need <span id="breakEvenAmount" class="font-semibold text-yellow-400">$170k</span> in cuts or <span id="revenueIncrease" class="font-semibold text-yellow-400">3%</span> revenue increase to reach operating breakeven</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-red-500 mt-0.5">‚óè</span>
                                <span class="text-gray-300 text-sm">Despite <span id="grossMarginPercent" class="font-semibold text-emerald-400">70%</span> gross margins, OpEx efficiency is killing profitability</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 12-Month View -->
        <div id="monthView" class="month-view glass-card rounded-xl p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-200">12-Month Income Statement</h3>
                <!-- Quick Actions Bar -->
                <div class="flex gap-2">
                    <button onclick="applyMonthlyScenario('growth')" class="text-xs px-3 py-1 bg-emerald-600 text-white rounded hover:bg-emerald-700">
                        Apply 5% Growth
                    </button>
                    <button onclick="applyMonthlyScenario('cost-cut')" class="text-xs px-3 py-1 bg-orange-600 text-white rounded hover:bg-orange-700">
                        Cut 10% Costs
                    </button>
                    <button onclick="applyMonthlyScenario('copy-budget')" class="text-xs px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Copy Budget to Actuals
                    </button>
                    <button onclick="resetMonthlyData()" class="text-xs px-3 py-1 bg-slate-600 text-white rounded hover:bg-slate-700">
                        Reset All Changes
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto relative">
                <div class="min-w-[1800px]">
                    <table class="w-full text-xs monthly-pnl-table">
                        <thead class="sticky-header">
                            <!-- Section Headers -->
                            <tr class="border-b border-gray-700">
                                <th class="sticky-column text-left py-2 px-3 bg-slate-900 font-semibold text-gray-300" rowspan="2">Account</th>
                                <th colspan="12" class="text-center py-2 px-2 bg-[#1e293b] text-blue-300 font-semibold border-l border-gray-600">ACTUALS</th>
                                <th colspan="12" class="text-center py-2 px-2 bg-[#374151] text-gray-300 font-semibold border-l border-gray-600">BUDGET</th>
                                <th colspan="12" class="text-center py-2 px-2 bg-[#4c1d95] text-purple-300 font-semibold border-l border-gray-600">VARIANCE (Act vs Bud)</th>
                                <th class="text-center py-2 px-3 bg-slate-800 text-emerald-300 font-semibold border-l border-gray-600" rowspan="2">YTD Total</th>
                            </tr>
                            <!-- Month Names -->
                            <tr class="border-b border-gray-700">
                                <!-- Actuals Months -->
                                <th class="text-right py-2 px-1 bg-[#1e293b] text-gray-400 border-l border-gray-600">Jan</th>
                                <th class="text-right py-2 px-1 bg-[#1e293b] text-gray-400">Feb</th>
                                <th class="text-right py-2 px-1 bg-[#1e293b] text-gray-400">Mar</th>
                                <th class="text-right py-2 px-1 bg-[#1e293b] text-gray-400">Apr</th>
                                <th class="text-right py-2 px-1 bg-[#1e293b] text-gray-400">May</th>
                                <th class="text-right py-2 px-1 bg-[#1e293b] text-gray-400">Jun</th>
                                <th class="text-right py-2 px-1 bg-[#1e293b] text-gray-400">Jul</th>
                                <th class="text-right py-2 px-1 bg-[#1e293b] text-gray-400">Aug</th>
                                <th class="text-right py-2 px-1 bg-[#1e293b] text-gray-400">Sep</th>
                                <th class="text-right py-2 px-1 bg-[#1e293b] text-gray-400">Oct</th>
                                <th class="text-right py-2 px-1 bg-[#1e293b] text-gray-400">Nov</th>
                                <th class="text-right py-2 px-1 bg-[#1e293b] text-gray-400">Dec</th>
                                <!-- Budget Months -->
                                <th class="text-right py-2 px-1 bg-[#374151] text-gray-400 border-l border-gray-600">Jan</th>
                                <th class="text-right py-2 px-1 bg-[#374151] text-gray-400">Feb</th>
                                <th class="text-right py-2 px-1 bg-[#374151] text-gray-400">Mar</th>
                                <th class="text-right py-2 px-1 bg-[#374151] text-gray-400">Apr</th>
                                <th class="text-right py-2 px-1 bg-[#374151] text-gray-400">May</th>
                                <th class="text-right py-2 px-1 bg-[#374151] text-gray-400">Jun</th>
                                <th class="text-right py-2 px-1 bg-[#374151] text-gray-400">Jul</th>
                                <th class="text-right py-2 px-1 bg-[#374151] text-gray-400">Aug</th>
                                <th class="text-right py-2 px-1 bg-[#374151] text-gray-400">Sep</th>
                                <th class="text-right py-2 px-1 bg-[#374151] text-gray-400">Oct</th>
                                <th class="text-right py-2 px-1 bg-[#374151] text-gray-400">Nov</th>
                                <th class="text-right py-2 px-1 bg-[#374151] text-gray-400">Dec</th>
                                <!-- Variance Months -->
                                <th class="text-right py-2 px-1 bg-[#4c1d95] text-gray-400 border-l border-gray-600">Jan</th>
                                <th class="text-right py-2 px-1 bg-[#4c1d95] text-gray-400">Feb</th>
                                <th class="text-right py-2 px-1 bg-[#4c1d95] text-gray-400">Mar</th>
                                <th class="text-right py-2 px-1 bg-[#4c1d95] text-gray-400">Apr</th>
                                <th class="text-right py-2 px-1 bg-[#4c1d95] text-gray-400">May</th>
                                <th class="text-right py-2 px-1 bg-[#4c1d95] text-gray-400">Jun</th>
                                <th class="text-right py-2 px-1 bg-[#4c1d95] text-gray-400">Jul</th>
                                <th class="text-right py-2 px-1 bg-[#4c1d95] text-gray-400">Aug</th>
                                <th class="text-right py-2 px-1 bg-[#4c1d95] text-gray-400">Sep</th>
                                <th class="text-right py-2 px-1 bg-[#4c1d95] text-gray-400">Oct</th>
                                <th class="text-right py-2 px-1 bg-[#4c1d95] text-gray-400">Nov</th>
                                <th class="text-right py-2 px-1 bg-[#4c1d95] text-gray-400">Dec</th>
                            </tr>
                        </thead>
                        <tbody id="monthTableBody">
                            <!-- Dynamic monthly content -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Summary Row -->
            <div class="mt-4 p-4 bg-slate-800/50 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div>
                        <span class="text-gray-400">Average Monthly Burn:</span>
                        <span id="avgBurnActual" class="font-semibold text-red-400 ml-2">--</span>
                        <span class="text-gray-500 mx-2">vs</span>
                        <span id="avgBurnBudget" class="font-semibold text-yellow-400">--</span>
                    </div>
                    <div>
                        <span class="text-gray-400">Best Month:</span>
                        <span id="bestMonth" class="font-semibold text-emerald-400 ml-2">--</span>
                        <span class="text-gray-500 mx-2">|</span>
                        <span class="text-gray-400">Worst:</span>
                        <span id="worstMonth" class="font-semibold text-red-400 ml-2">--</span>
                    </div>
                    <div>
                        <span class="text-gray-400">Months to Breakeven:</span>
                        <span id="monthsToBreakeven" class="font-semibold text-blue-400 ml-2">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Waterfall Chart View -->
        <div id="waterfallView" class="glass-card rounded-xl p-6 mb-6 hidden">
            <canvas id="waterfallChart" width="400" height="200"></canvas>
        </div>

        <!-- Trend Analysis View -->
        <div id="trendView" class="glass-card rounded-xl p-6 mb-6 hidden">
            <canvas id="trendChart" width="400" height="200"></canvas>
        </div>

        <!-- Key Metrics Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="glass-card rounded-xl p-4">
                <h3 class="text-sm text-gray-400 mb-1">Gross Margin</h3>
                <div class="text-2xl font-bold text-emerald-400" id="grossMargin">--</div>
                <div class="text-xs text-gray-500 mt-1" id="grossMarginTrend">--</div>
            </div>
            <div class="glass-card rounded-xl p-4">
                <h3 class="text-sm text-gray-400 mb-1">Operating Margin</h3>
                <div class="text-2xl font-bold text-blue-400" id="operatingMargin">--</div>
                <div class="text-xs text-gray-500 mt-1" id="operatingMarginTrend">--</div>
            </div>
            <div class="glass-card rounded-xl p-4">
                <h3 class="text-sm text-gray-400 mb-1">EBITDA Margin</h3>
                <div class="text-2xl font-bold text-purple-400" id="ebitdaMargin">--</div>
                <div class="text-xs text-gray-500 mt-1" id="ebitdaMarginTrend">--</div>
            </div>
            <div class="glass-card rounded-xl p-4">
                <h3 class="text-sm text-gray-400 mb-1">Net Margin</h3>
                <div class="text-2xl font-bold text-orange-400" id="netMargin">--</div>
                <div class="text-xs text-gray-500 mt-1" id="netMarginTrend">--</div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Chart of Accounts with expandable details
        const chartOfAccounts = {
            revenue: {
                name: 'Revenue',
                level: 0,
                editable: true,
                children: {
                    'saas': { name: 'SaaS Revenue', level: 1, percentage: 60 },
                    'services': { name: 'Professional Services', level: 1, percentage: 40 }
                }
            },
            cogs: {
                name: 'Cost of Goods Sold',
                level: 0,
                editable: false,
                children: {}
            },
            opex: {
                name: 'Operating Expenses',
                level: 0,
                editable: true,
                children: {
                    'salaries': { name: 'Salaries & Benefits', level: 1, percentage: 65 },
                    'marketing': { name: 'Sales & Marketing', level: 1, percentage: 20 },
                    'other': { name: 'Other OpEx', level: 1, percentage: 15 }
                }
            },
            other: {
                name: 'Other Income/Expenses',
                level: 0,
                editable: false,
                children: {}
            }
        };

        // Financial data with original values preserved
        const originalData = {
            revenue: 7950000,
            cogs: 2350000,
            opex: 5770000,
            other: -36000
        };

        // Current financial data (mutable)
        let financialData = {
            revenue: 7950000,
            cogs: 2350000,
            opex: 5770000,
            other: -36000
        };

        // Comprehensive monthly data structure
        const monthlyDataOriginal = {
            revenue: {
                actuals: [650000, 680000, 720000, 700000, 730000, 750000, 780000, 795000, 800000, 820000, 840000, 860000],
                budget: [640000, 660000, 700000, 700000, 720000, 740000, 760000, 780000, 790000, 800000, 820000, 840000],
                children: {
                    saas: { 
                        actuals: [390000, 408000, 432000, 420000, 438000, 450000, 468000, 477000, 480000, 492000, 504000, 516000],
                        budget: [384000, 396000, 420000, 420000, 432000, 444000, 456000, 468000, 474000, 480000, 492000, 504000]
                    },
                    services: {
                        actuals: [260000, 272000, 288000, 280000, 292000, 300000, 312000, 318000, 320000, 328000, 336000, 344000],
                        budget: [256000, 264000, 280000, 280000, 288000, 296000, 304000, 312000, 316000, 320000, 328000, 336000]
                    }
                }
            },
            cogs: {
                actuals: [192000, 201000, 213000, 207000, 216000, 222000, 231000, 235500, 237000, 243000, 249000, 255000],
                budget: [190000, 196000, 208000, 208000, 214000, 220000, 226000, 232000, 235000, 238000, 244000, 250000],
                children: {
                    direct: {
                        actuals: [115200, 120600, 127800, 124200, 129600, 133200, 138600, 141300, 142200, 145800, 149400, 153000],
                        budget: [114000, 117600, 124800, 124800, 128400, 132000, 135600, 139200, 141000, 142800, 146400, 150000]
                    },
                    materials: {
                        actuals: [76800, 80400, 85200, 82800, 86400, 88800, 92400, 94200, 94800, 97200, 99600, 102000],
                        budget: [76000, 78400, 83200, 83200, 85600, 88000, 90400, 92800, 94000, 95200, 97600, 100000]
                    }
                }
            },
            opex: {
                actuals: [476000, 486000, 496000, 491000, 501000, 506000, 516000, 521000, 526000, 531000, 536000, 541000],
                budget: [470000, 480000, 490000, 485000, 495000, 500000, 510000, 515000, 520000, 525000, 530000, 535000],
                children: {
                    salaries: {
                        actuals: [309400, 315900, 322400, 319150, 325650, 328900, 335400, 338650, 341900, 345150, 348400, 351650],
                        budget: [305500, 312000, 318500, 315250, 321750, 325000, 331500, 334750, 338000, 341250, 344500, 347750]
                    },
                    marketing: {
                        actuals: [95200, 97200, 99200, 98200, 100200, 101200, 103200, 104200, 105200, 106200, 107200, 108200],
                        budget: [94000, 96000, 98000, 97000, 99000, 100000, 102000, 103000, 104000, 105000, 106000, 107000]
                    },
                    other: {
                        actuals: [71400, 72900, 74400, 73650, 75150, 75900, 77400, 78150, 78900, 79650, 80400, 81150],
                        budget: [70500, 72000, 73500, 72750, 74250, 75000, 76500, 77250, 78000, 78750, 79500, 80250]
                    }
                }
            },
            other: {
                actuals: [-3000, -3000, -3000, -3000, -3000, -3000, -3000, -3000, -3000, -3000, -3000, -3000],
                budget: [-3000, -3000, -3000, -3000, -3000, -3000, -3000, -3000, -3000, -3000, -3000, -3000]
            }
        };

        // Create mutable copy
        let monthlyData = JSON.parse(JSON.stringify(monthlyDataOriginal));

        let currentPeriod = 'q3';
        let currentView = 'table';
        let waterfallChart = null;
        let trendChart = null;
        let hasEdits = false;

        function formatCurrency(value, showSign = false) {
            const formatted = new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(Math.abs(value));
            
            if (showSign && value !== 0) {
                return value > 0 ? '+$' + formatted : '-$' + formatted;
            }
            return '$' + formatted;
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function renderPnLTable() {
            const tbody = document.getElementById('pnlTableBody');
            tbody.innerHTML = '';

            const grossProfit = financialData.revenue - financialData.cogs;
            const operatingIncome = grossProfit - financialData.opex;
            const netIncome = operatingIncome + financialData.other;

            // Render Revenue section
            renderMainRow(tbody, 'Revenue', financialData.revenue, originalData.revenue, 'revenue');
            if (chartOfAccounts.revenue.expanded) {
                renderChildRows(tbody, chartOfAccounts.revenue.children, financialData.revenue);
            }
            
            tbody.innerHTML += '<tr><td colspan="6" class="py-2"></td></tr>';
            
            // Render COGS
            renderMainRow(tbody, 'Cost of Goods Sold', financialData.cogs, originalData.cogs, 'cogs', false);
            
            tbody.innerHTML += '<tr><td colspan="6" class="py-2"></td></tr>';
            renderTotalRow(tbody, 'Gross Profit', grossProfit, (originalData.revenue - originalData.cogs));
            
            tbody.innerHTML += '<tr><td colspan="6" class="py-2"></td></tr>';
            
            // Render OpEx section
            renderMainRow(tbody, 'Operating Expenses', financialData.opex, originalData.opex, 'opex');
            if (chartOfAccounts.opex.expanded) {
                renderChildRows(tbody, chartOfAccounts.opex.children, financialData.opex);
            }
            
            tbody.innerHTML += '<tr><td colspan="6" class="py-2"></td></tr>';
            renderTotalRow(tbody, 'Operating Income', operatingIncome, (originalData.revenue - originalData.cogs - originalData.opex));
            
            tbody.innerHTML += '<tr><td colspan="6" class="py-2"></td></tr>';
            
            // Render Other
            renderMainRow(tbody, 'Other Income/Expenses', financialData.other, originalData.other, 'other', false);
            
            tbody.innerHTML += '<tr><td colspan="6" class="py-2"></td></tr>';
            renderTotalRow(tbody, 'Net Income', netIncome, (originalData.revenue - originalData.cogs - originalData.opex + originalData.other));

            // Update metrics and insights
            updateMetrics(grossProfit, operatingIncome, netIncome);
            updateWarningBanner();
            updateInsights();
        }

        function renderMainRow(tbody, label, actual, budget, category, expandable = true) {
            const row = document.createElement('tr');
            row.className = 'account-row font-semibold text-gray-200';
            
            const variance = actual - budget;
            const variancePercent = budget !== 0 ? (variance / budget * 100) : 0;
            const delta = hasEdits && actual !== budget ? ((actual - budget) / budget * 100) : 0;
            
            row.innerHTML = `
                <td class="py-2 px-2">
                    ${expandable ? `<span class="expandable cursor-pointer" onclick="toggleExpand('${category}')">
                        ${chartOfAccounts[category].expanded ? '‚ñº' : '‚ñ∂'} ${label}
                    </span>` : label}
                </td>
                <td class="text-right py-2 px-2">
                    ${chartOfAccounts[category].editable ? 
                        `<span class="editable-value" onclick="editValue('${category}')" id="${category}-value">
                            ${formatCurrency(actual)}
                        </span>` : 
                        formatCurrency(actual)
                    }
                    ${delta !== 0 ? `<span class="delta-indicator ${delta > 0 ? 'text-emerald-400' : 'text-red-400'}">
                        ${delta > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(delta).toFixed(0)}%
                    </span>` : ''}
                </td>
                <td class="text-right py-2 px-2">${formatCurrency(budget)}</td>
                <td class="text-right py-2 px-2 ${variance >= 0 ? 'positive-variance' : 'negative-variance'}">
                    ${formatCurrency(Math.abs(variance))}
                </td>
                <td class="text-right py-2 px-2 ${variance >= 0 ? 'positive-variance' : 'negative-variance'}">
                    ${variancePercent.toFixed(1)}%
                </td>
                <td class="text-right py-2 px-2">${(actual / financialData.revenue * 100).toFixed(1)}%</td>
            `;
            tbody.appendChild(row);
        }

        function renderChildRows(tbody, children, parentTotal) {
            Object.entries(children).forEach(([key, child]) => {
                const amount = parentTotal * (child.percentage / 100);
                const row = document.createElement('tr');
                row.className = 'text-gray-400 child-account';
                
                row.innerHTML = `
                    <td class="py-1 px-2 pl-8">‚îî‚îÄ ${child.name}</td>
                    <td class="text-right py-1 px-2">${formatCurrency(amount)}</td>
                    <td class="text-right py-1 px-2 text-gray-500">${child.percentage}% of total</td>
                    <td colspan="3"></td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderTotalRow(tbody, label, actual, budget) {
            const row = document.createElement('tr');
            const isNegative = actual < 0;
            row.className = 'font-bold text-white bg-slate-800 border-t border-gray-600';
            
            const variance = actual - budget;
            const variancePercent = budget !== 0 ? (variance / budget * 100) : 0;
            
            row.innerHTML = `
                <td class="py-2 px-2">${label}</td>
                <td class="text-right py-2 px-2 ${isNegative ? 'negative-value' : ''}">${formatCurrency(actual)}</td>
                <td class="text-right py-2 px-2">${formatCurrency(budget)}</td>
                <td class="text-right py-2 px-2 ${variance >= 0 ? 'positive-variance' : 'negative-variance'}">
                    ${formatCurrency(Math.abs(variance))}
                </td>
                <td class="text-right py-2 px-2 ${variance >= 0 ? 'positive-variance' : 'negative-variance'}">
                    ${variancePercent.toFixed(1)}%
                </td>
                <td class="text-right py-2 px-2">${(actual / financialData.revenue * 100).toFixed(1)}%</td>
            `;
            tbody.appendChild(row);
        }

        // Interactive editing functions
        function editValue(category) {
            const span = document.getElementById(`${category}-value`);
            const currentValue = financialData[category];
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'editing-input';
            input.value = formatNumber(currentValue);
            
            input.onblur = function() {
                const newValue = parseInt(input.value.replace(/,/g, '')) || currentValue;
                financialData[category] = newValue;
                hasEdits = true;
                document.getElementById('resetButton').classList.remove('hidden');
                renderPnLTable();
            };
            
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    input.blur();
                }
            };
            
            span.innerHTML = '';
            span.appendChild(input);
            input.focus();
            input.select();
        }

        function toggleExpand(category) {
            chartOfAccounts[category].expanded = !chartOfAccounts[category].expanded;
            renderPnLTable();
        }

        function applyScenario(scenario) {
            hasEdits = true;
            document.getElementById('resetButton').classList.remove('hidden');
            
            if (scenario === 'growth') {
                financialData.revenue = Math.round(originalData.revenue * 1.15);
            } else if (scenario === 'cost-cut') {
                financialData.opex = Math.round(originalData.opex * 0.9);
            }
            
            renderPnLTable();
        }

        function resetValues() {
            financialData = { ...originalData };
            hasEdits = false;
            document.getElementById('resetButton').classList.add('hidden');
            renderPnLTable();
        }

        function toggleInsights() {
            const box = document.getElementById('insightsBox');
            const toggle = document.getElementById('insightsToggle');
            
            if (box.classList.contains('expanded')) {
                box.classList.remove('expanded');
                toggle.textContent = '‚ñ∂';
            } else {
                box.classList.add('expanded');
                toggle.textContent = '‚ñº';
            }
        }

        function toggleMonthView() {
            const monthView = document.getElementById('monthView');
            const standardView = document.getElementById('tableView');
            
            if (monthView.classList.contains('active')) {
                monthView.classList.remove('active');
                standardView.classList.remove('hidden');
            } else {
                monthView.classList.add('active');
                standardView.classList.add('hidden');
                renderMonthlyView();
            }
        }

        function updateMetrics(grossProfit, operatingIncome, netIncome) {
            const grossMargin = (grossProfit / financialData.revenue * 100).toFixed(1);
            const operatingMargin = (operatingIncome / financialData.revenue * 100).toFixed(1);
            const ebitdaMargin = ((operatingIncome + 250000) / financialData.revenue * 100).toFixed(1);
            const netMargin = (netIncome / financialData.revenue * 100).toFixed(1);

            document.getElementById('grossMargin').textContent = grossMargin + '%';
            document.getElementById('operatingMargin').textContent = operatingMargin + '%';
            document.getElementById('ebitdaMargin').textContent = ebitdaMargin + '%';
            document.getElementById('netMargin').textContent = netMargin + '%';

            // Update trends based on actuals
            document.getElementById('grossMarginTrend').innerHTML = grossMargin > 70 ? 
                '<span class="trend-up">‚Üë Above target</span>' : 
                '<span class="trend-down">‚Üì Below target</span>';
            document.getElementById('operatingMarginTrend').innerHTML = operatingMargin > 0 ? 
                '<span class="trend-up">‚Üë Profitable</span>' : 
                '<span class="trend-down">‚Üì Loss</span>';
            document.getElementById('ebitdaMarginTrend').innerHTML = ebitdaMargin > 5 ? 
                '<span class="trend-up">‚Üë Healthy</span>' : 
                '<span class="trend-down">‚Üì Concerning</span>';
            document.getElementById('netMarginTrend').innerHTML = netMargin > 0 ? 
                '<span class="trend-up">‚Üë Profitable</span>' : 
                '<span class="trend-down">‚Üì Loss</span>';
        }

        function updateWarningBanner() {
            const grossProfit = financialData.revenue - financialData.cogs;
            const operatingIncome = grossProfit - financialData.opex;
            const banner = document.getElementById('warningBanner');
            
            if (operatingIncome < 0) {
                const loss = Math.abs(operatingIncome);
                const breakEvenCut = (financialData.opex - grossProfit) / financialData.opex * 100;
                
                document.getElementById('opexAmount').textContent = formatCurrency(financialData.opex);
                document.getElementById('grossProfitAmount').textContent = formatCurrency(grossProfit);
                document.getElementById('lossAmount').textContent = formatCurrency(loss);
                
                banner.innerHTML = `
                    <span class="text-2xl">‚ö†Ô∏è</span>
                    <span class="text-yellow-200 text-sm font-medium">
                        Operating Expenses (${formatCurrency(financialData.opex)}) exceed Gross Profit (${formatCurrency(grossProfit)}) by ${formatCurrency(loss)} - Reduce OpEx by ${breakEvenCut.toFixed(0)}% to break even
                    </span>
                `;
                banner.style.display = 'flex';
            } else {
                banner.style.display = 'none';
            }
        }

        function updateInsights() {
            const grossProfit = financialData.revenue - financialData.cogs;
            const operatingIncome = grossProfit - financialData.opex;
            const netIncome = operatingIncome + financialData.other;
            
            // Update burn rate
            const monthlyBurn = Math.abs(netIncome) / 3; // Q3 = 3 months
            document.getElementById('burnRate').textContent = formatCurrency(monthlyBurn) + '/month';
            
            // Update breakeven analysis
            const breakEvenCut = Math.abs(operatingIncome);
            const revenueIncrease = (breakEvenCut / financialData.revenue * 100).toFixed(0);
            document.getElementById('breakEvenAmount').textContent = formatCurrency(breakEvenCut);
            document.getElementById('revenueIncrease').textContent = revenueIncrease + '%';
            
            // Update gross margin
            const grossMargin = (grossProfit / financialData.revenue * 100).toFixed(0);
            document.getElementById('grossMarginPercent').textContent = grossMargin + '%';
        }

        function renderMonthlyView() {
            const tbody = document.getElementById('monthTableBody');
            tbody.innerHTML = '';
            
            // Revenue section
            renderMonthlyAccountRow(tbody, 'Revenue', 'revenue', true);
            
            // COGS section
            renderMonthlyAccountRow(tbody, 'Cost of Goods Sold', 'cogs', true);
            
            // Gross Profit
            renderMonthlySectionDivider(tbody);
            renderMonthlyCalculatedRow(tbody, 'Gross Profit', calculateMonthlyGrossProfit());
            renderMonthlyMarginRow(tbody, 'Gross Margin %', calculateMonthlyGrossMargin());
            
            // Operating Expenses
            renderMonthlySectionDivider(tbody);
            renderMonthlyAccountRow(tbody, 'Operating Expenses', 'opex', true);
            
            // Operating Income
            renderMonthlySectionDivider(tbody);
            renderMonthlyCalculatedRow(tbody, 'Operating Income', calculateMonthlyOperatingIncome());
            renderMonthlyMarginRow(tbody, 'Operating Margin %', calculateMonthlyOperatingMargin());
            
            // Other Income/Expenses
            renderMonthlySectionDivider(tbody);
            renderMonthlyAccountRow(tbody, 'Other Income/Expenses', 'other', false);
            
            // Net Income
            renderMonthlySectionDivider(tbody);
            renderMonthlyCalculatedRow(tbody, 'Net Income', calculateMonthlyNetIncome(), true);
            renderMonthlyMarginRow(tbody, 'Net Margin %', calculateMonthlyNetMargin());
            
            // Update summary metrics
            updateMonthlySummary();
        }

        function toggleView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('bg-emerald-600', 'text-white');
                btn.classList.add('bg-slate-700', 'text-gray-300');
            });
            event.target.classList.remove('bg-slate-700', 'text-gray-300');
            event.target.classList.add('bg-emerald-600', 'text-white');

            document.getElementById('tableView').classList.toggle('hidden', view !== 'table');
            document.getElementById('waterfallView').classList.toggle('hidden', view !== 'waterfall');
            document.getElementById('trendView').classList.toggle('hidden', view !== 'trend');

            if (view === 'waterfall') {
                renderWaterfallChart();
            } else if (view === 'trend') {
                renderTrendChart();
            }
        }

        function renderWaterfallChart() {
            const ctx = document.getElementById('waterfallChart').getContext('2d');
            
            if (waterfallChart) {
                waterfallChart.destroy();
            }

            const revenue = financialData.revenue;
            const cogs = financialData.cogs;
            const opex = financialData.opex;
            const other = financialData.other;
            const grossProfit = revenue - cogs;
            const operatingIncome = grossProfit - opex;
            const netIncome = operatingIncome + other;

            waterfallChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Revenue', 'COGS', 'Gross Profit', 'OpEx', 'Operating Income', 'Other', 'Net Income'],
                    datasets: [{
                        data: [revenue, -cogs, grossProfit, -opex, operatingIncome, other, netIncome],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            operatingIncome >= 0 ? 'rgba(139, 92, 246, 0.8)' : 'rgba(239, 68, 68, 0.8)',
                            other >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)',
                            netIncome >= 0 ? 'rgba(251, 146, 60, 0.8)' : 'rgba(239, 68, 68, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(Math.abs(context.raw))
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => formatCurrency(value),
                                color: '#9ca3af'
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function renderTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
            }

            // Calculate cumulative values for YTD
            const revenueData = [];
            const grossProfitData = [];
            const netIncomeData = [];
            
            for (let i = 0; i < 9; i++) {
                const monthlyRevenue = monthlyData.revenue.actual[i];
                const monthlyCogs = monthlyData.cogs.actual[i];
                const monthlyOpex = monthlyData.opex.actual[i];
                
                revenueData.push(monthlyRevenue);
                grossProfitData.push(monthlyRevenue - monthlyCogs);
                netIncomeData.push(monthlyRevenue - monthlyCogs - monthlyOpex - 3000);
            }

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'],
                    datasets: [{
                        label: 'Revenue',
                        data: revenueData,
                        borderColor: 'rgba(16, 185, 129, 1)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Gross Profit',
                        data: grossProfitData,
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Net Income',
                        data: netIncomeData,
                        borderColor: 'rgba(251, 146, 60, 1)',
                        backgroundColor: 'rgba(251, 146, 60, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#9ca3af' }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => context.dataset.label + ': ' + formatCurrency(context.raw)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => '$' + (value / 1000).toFixed(0) + 'k',
                                color: '#9ca3af'
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // Monthly view helper functions
        function renderMonthlyAccountRow(tbody, label, category, expandable) {
            const row = document.createElement('tr');
            row.className = 'account-row';
            
            // Account name column
            let accountCell = `<td class="sticky-column py-2 px-3 font-semibold text-gray-200">`;
            if (expandable) {
                accountCell += `<span class="expandable cursor-pointer" onclick="toggleMonthlyExpand('${category}')">
                    ${chartOfAccounts[category].expandedMonthly ? '‚ñº' : '‚ñ∂'} ${label}
                </span>`;
            } else {
                accountCell += label;
            }
            accountCell += '</td>';
            
            row.innerHTML = accountCell;
            
            // Add actual values
            monthlyData[category].actuals.forEach((value, i) => {
                row.innerHTML += `<td class="text-right py-2 px-1 border-l border-gray-700 editable-cell" 
                    onclick="editMonthlyCell('${category}', 'actuals', ${i})" 
                    id="${category}-actual-${i}">
                    ${formatMonthlyValue(value)}
                </td>`;
            });
            
            // Add budget values
            monthlyData[category].budget.forEach((value, i) => {
                row.innerHTML += `<td class="text-right py-2 px-1 ${i === 0 ? 'border-l border-gray-600' : ''} editable-cell" 
                    onclick="editMonthlyCell('${category}', 'budget', ${i})"
                    id="${category}-budget-${i}">
                    ${formatMonthlyValue(value)}
                </td>`;
            });
            
            // Add variance values
            monthlyData[category].actuals.forEach((actual, i) => {
                const budget = monthlyData[category].budget[i];
                const variance = actual - budget;
                const varianceClass = getVarianceClass(variance, budget, category === 'cogs' || category === 'opex');
                row.innerHTML += `<td class="text-right py-2 px-1 ${i === 0 ? 'border-l border-gray-600' : ''} ${varianceClass}">
                    ${formatVariance(variance)}
                </td>`;
            });
            
            // Add YTD total
            const ytdActual = monthlyData[category].actuals.reduce((sum, val) => sum + val, 0);
            row.innerHTML += `<td class="text-right py-2 px-3 border-l border-gray-600 font-semibold text-emerald-300">
                ${formatMonthlyValue(ytdActual)}
            </td>`;
            
            tbody.appendChild(row);
        }

        function renderMonthlyCalculatedRow(tbody, label, values, isNetIncome = false) {
            const row = document.createElement('tr');
            row.className = isNetIncome ? 'font-bold text-white bg-slate-800' : 'font-semibold text-gray-200';
            
            row.innerHTML = `<td class="sticky-column py-2 px-3">${label}</td>`;
            
            // Actuals
            values.actuals.forEach((value, i) => {
                const valueClass = value < 0 ? 'negative-value' : '';
                row.innerHTML += `<td class="text-right py-2 px-1 border-l border-gray-700 ${valueClass}">
                    ${formatMonthlyValue(value)}
                </td>`;
            });
            
            // Budget
            values.budget.forEach((value, i) => {
                const valueClass = value < 0 ? 'negative-value' : '';
                row.innerHTML += `<td class="text-right py-2 px-1 ${i === 0 ? 'border-l border-gray-600' : ''} ${valueClass}">
                    ${formatMonthlyValue(value)}
                </td>`;
            });
            
            // Variance
            values.actuals.forEach((actual, i) => {
                const budget = values.budget[i];
                const variance = actual - budget;
                const varianceClass = getVarianceClass(variance, budget, false);
                row.innerHTML += `<td class="text-right py-2 px-1 ${i === 0 ? 'border-l border-gray-600' : ''} ${varianceClass}">
                    ${formatVariance(variance)}
                </td>`;
            });
            
            // YTD
            const ytd = values.actuals.reduce((sum, val) => sum + val, 0);
            const ytdClass = ytd < 0 ? 'text-red-400' : 'text-emerald-300';
            row.innerHTML += `<td class="text-right py-2 px-3 border-l border-gray-600 font-semibold ${ytdClass}">
                ${formatMonthlyValue(ytd)}
            </td>`;
            
            tbody.appendChild(row);
        }

        function renderMonthlyMarginRow(tbody, label, values) {
            const row = document.createElement('tr');
            row.className = 'text-gray-400';
            
            row.innerHTML = `<td class="sticky-column py-1 px-3">${label}</td>`;
            
            // Actuals
            values.actuals.forEach((value, i) => {
                const valueClass = value < 0 ? 'negative-value' : '';
                row.innerHTML += `<td class="text-right py-1 px-1 border-l border-gray-700 text-xs ${valueClass}">
                    ${value.toFixed(1)}%
                </td>`;
            });
            
            // Budget
            values.budget.forEach((value, i) => {
                const valueClass = value < 0 ? 'negative-value' : '';
                row.innerHTML += `<td class="text-right py-1 px-1 ${i === 0 ? 'border-l border-gray-600' : ''} text-xs ${valueClass}">
                    ${value.toFixed(1)}%
                </td>`;
            });
            
            // Variance
            values.actuals.forEach((actual, i) => {
                const budget = values.budget[i];
                const variance = actual - budget;
                const varianceClass = variance >= 0 ? 'positive-variance' : 'negative-variance';
                row.innerHTML += `<td class="text-right py-1 px-1 ${i === 0 ? 'border-l border-gray-600' : ''} text-xs ${varianceClass}">
                    ${variance >= 0 ? '+' : ''}${variance.toFixed(1)}%
                </td>`;
            });
            
            // YTD
            row.innerHTML += `<td class="text-right py-1 px-3 border-l border-gray-600 text-xs">
                ${values.ytd.toFixed(1)}%
            </td>`;
            
            tbody.appendChild(row);
        }

        function renderMonthlySectionDivider(tbody) {
            const row = document.createElement('tr');
            row.className = 'section-divider';
            row.innerHTML = '<td colspan="38" class="py-1"></td>';
            tbody.appendChild(row);
        }

        // Calculation functions
        function calculateMonthlyGrossProfit() {
            return {
                actuals: monthlyData.revenue.actuals.map((rev, i) => rev - monthlyData.cogs.actuals[i]),
                budget: monthlyData.revenue.budget.map((rev, i) => rev - monthlyData.cogs.budget[i])
            };
        }

        function calculateMonthlyGrossMargin() {
            const grossProfit = calculateMonthlyGrossProfit();
            const ytdRevenue = monthlyData.revenue.actuals.reduce((sum, val) => sum + val, 0);
            const ytdGrossProfit = grossProfit.actuals.reduce((sum, val) => sum + val, 0);
            
            return {
                actuals: grossProfit.actuals.map((gp, i) => (gp / monthlyData.revenue.actuals[i] * 100)),
                budget: grossProfit.budget.map((gp, i) => (gp / monthlyData.revenue.budget[i] * 100)),
                ytd: (ytdGrossProfit / ytdRevenue * 100)
            };
        }

        function calculateMonthlyOperatingIncome() {
            const grossProfit = calculateMonthlyGrossProfit();
            return {
                actuals: grossProfit.actuals.map((gp, i) => gp - monthlyData.opex.actuals[i]),
                budget: grossProfit.budget.map((gp, i) => gp - monthlyData.opex.budget[i])
            };
        }

        function calculateMonthlyOperatingMargin() {
            const operatingIncome = calculateMonthlyOperatingIncome();
            const ytdRevenue = monthlyData.revenue.actuals.reduce((sum, val) => sum + val, 0);
            const ytdOperatingIncome = operatingIncome.actuals.reduce((sum, val) => sum + val, 0);
            
            return {
                actuals: operatingIncome.actuals.map((oi, i) => (oi / monthlyData.revenue.actuals[i] * 100)),
                budget: operatingIncome.budget.map((oi, i) => (oi / monthlyData.revenue.budget[i] * 100)),
                ytd: (ytdOperatingIncome / ytdRevenue * 100)
            };
        }

        function calculateMonthlyNetIncome() {
            const operatingIncome = calculateMonthlyOperatingIncome();
            return {
                actuals: operatingIncome.actuals.map((oi, i) => oi + monthlyData.other.actuals[i]),
                budget: operatingIncome.budget.map((oi, i) => oi + monthlyData.other.budget[i])
            };
        }

        function calculateMonthlyNetMargin() {
            const netIncome = calculateMonthlyNetIncome();
            const ytdRevenue = monthlyData.revenue.actuals.reduce((sum, val) => sum + val, 0);
            const ytdNetIncome = netIncome.actuals.reduce((sum, val) => sum + val, 0);
            
            return {
                actuals: netIncome.actuals.map((ni, i) => (ni / monthlyData.revenue.actuals[i] * 100)),
                budget: netIncome.budget.map((ni, i) => (ni / monthlyData.revenue.budget[i] * 100)),
                ytd: (ytdNetIncome / ytdRevenue * 100)
            };
        }

        // Formatting functions
        function formatMonthlyValue(value) {
            if (value === 0) return '$0';
            const absValue = Math.abs(value);
            const formatted = absValue >= 1000000 ? 
                `$${(absValue / 1000000).toFixed(1)}M` : 
                `$${(absValue / 1000).toFixed(0)}k`;
            return value < 0 ? `(${formatted})` : formatted;
        }

        function formatVariance(variance) {
            if (variance === 0) return '$0';
            const formatted = formatMonthlyValue(Math.abs(variance));
            return variance > 0 ? `+${formatted}` : `-${formatted.replace(/[()]/g, '')}`;
        }

        function getVarianceClass(variance, budget, isExpense) {
            const percentVariance = budget !== 0 ? Math.abs(variance / budget * 100) : 0;
            const isPositive = isExpense ? variance < 0 : variance > 0;
            
            if (percentVariance > 10) {
                return isPositive ? 'variance-high-positive' : 'variance-high-negative';
            } else if (percentVariance > 5) {
                return isPositive ? 'variance-med-positive' : 'variance-med-negative';
            } else {
                return isPositive ? 'variance-low-positive' : 'variance-low-negative';
            }
        }

        // Interactive functions
        function editMonthlyCell(category, type, monthIndex) {
            const cellId = `${category}-${type}-${monthIndex}`;
            const cell = document.getElementById(cellId);
            const currentValue = monthlyData[category][type][monthIndex];
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'editing-input';
            input.value = formatNumber(currentValue);
            
            input.onblur = function() {
                const newValue = parseInt(input.value.replace(/,/g, '')) || currentValue;
                monthlyData[category][type][monthIndex] = newValue;
                cell.classList.add('edited-cell');
                renderMonthlyView();
            };
            
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    input.blur();
                }
            };
            
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();
        }

        function toggleMonthlyExpand(category) {
            chartOfAccounts[category].expandedMonthly = !chartOfAccounts[category].expandedMonthly;
            renderMonthlyView();
        }

        function applyMonthlyScenario(scenario) {
            if (scenario === 'growth') {
                monthlyData.revenue.actuals = monthlyData.revenue.actuals.map(val => Math.round(val * 1.05));
            } else if (scenario === 'cost-cut') {
                monthlyData.opex.actuals = monthlyData.opex.actuals.map(val => Math.round(val * 0.9));
            } else if (scenario === 'copy-budget') {
                monthlyData.revenue.actuals = [...monthlyData.revenue.budget];
                monthlyData.cogs.actuals = [...monthlyData.cogs.budget];
                monthlyData.opex.actuals = [...monthlyData.opex.budget];
            }
            renderMonthlyView();
        }

        function resetMonthlyData() {
            monthlyData = JSON.parse(JSON.stringify(monthlyDataOriginal));
            document.querySelectorAll('.edited-cell').forEach(cell => {
                cell.classList.remove('edited-cell');
            });
            renderMonthlyView();
        }

        function updateMonthlySummary() {
            const netIncome = calculateMonthlyNetIncome();
            
            // Average monthly burn
            const avgBurnActual = netIncome.actuals.reduce((sum, val) => sum + val, 0) / 12;
            const avgBurnBudget = netIncome.budget.reduce((sum, val) => sum + val, 0) / 12;
            
            document.getElementById('avgBurnActual').textContent = formatCurrency(avgBurnActual) + '/mo';
            document.getElementById('avgBurnBudget').textContent = formatCurrency(avgBurnBudget) + '/mo';
            
            // Best and worst months
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const bestMonthIndex = netIncome.actuals.indexOf(Math.max(...netIncome.actuals));
            const worstMonthIndex = netIncome.actuals.indexOf(Math.min(...netIncome.actuals));
            
            document.getElementById('bestMonth').textContent = `${monthNames[bestMonthIndex]} (${formatCurrency(netIncome.actuals[bestMonthIndex])})`;
            document.getElementById('worstMonth').textContent = `${monthNames[worstMonthIndex]} (${formatCurrency(netIncome.actuals[worstMonthIndex])})`;
            
            // Months to breakeven
            if (avgBurnActual < 0) {
                const currentCash = 4250000; // From balance sheet
                const monthsToBreakeven = Math.round(currentCash / Math.abs(avgBurnActual));
                document.getElementById('monthsToBreakeven').textContent = monthsToBreakeven + ' months';
            } else {
                document.getElementById('monthsToBreakeven').textContent = 'Already profitable';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderPnLTable();
            
            document.getElementById('periodSelect').addEventListener('change', (e) => {
                currentPeriod = e.target.value;
                renderPnLTable();
                if (currentView === 'waterfall') renderWaterfallChart();
                if (currentView === 'trend') renderTrendChart();
            });
        });
    </script>
</body>
</html>
